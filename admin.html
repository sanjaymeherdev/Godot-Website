<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Courses - Godot 3D MP LMS</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/lms.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Vimeo Player API -->
    <script src="https://player.vimeo.com/api/player.js"></script>
</head>
<body>
    <!-- Header (keep your existing header) -->
    <header>
        <div class="container">
            <nav>
                <div class="logo">GODOT 3D MP</div>
                <div class="nav-links">
                    <a href="index.html">Home</a>
                    <a href="#dashboard">Dashboard</a>
                    <a href="#progress">My Progress</a>
                </div>
                <div class="user-menu">
                    <span id="userEmail" class="user-email"></span>
                    <span id="userTier" class="user-tier"></span>
                    <button id="logoutBtn" class="cta-button logout-btn">Logout</button>
                </div>
            </nav>
        </div>
    </header>

    <!-- Authentication Required Message -->
    <div id="authRequired" class="auth-required-message">
        <div class="container">
            <div class="auth-message">
                <h2>Authentication Required</h2>
                <p>Please log in to access the course content.</p>
                <a href="login.html" class="cta-button">Login / Sign Up</a>
            </div>
        </div>
    </div>

    <!-- Enhanced LMS Dashboard -->
    <section id="dashboard" class="lms-dashboard" style="display: none;">
        <div class="container">
            <div class="dashboard-header">
                <h1>Godot Multiplayer Courses</h1>
                <div class="user-info">
                    <p>Email: <span id="displayEmail"></span></p>
                    <p>Tier: <strong id="displayTier"></strong></p>
                </div>
            </div>

            <!-- Courses View -->
            <div id="coursesView" class="courses-view">
                <h2>Available Courses</h2>
                <div class="subscription-info">
                    <p>Current Tier: <strong id="currentTier">Free</strong></p>
                    <p>Purchased Courses: <strong id="purchasedCount">0</strong></p>
                </div>
                <div id="coursesContainer" class="courses-grid">
                    <!-- Courses loaded dynamically -->
                </div>
            </div>

            <!-- Single Course Player View -->
            <div id="coursePlayerView" class="course-player-view" style="display: none;">
                <div class="course-player-header">
                    <button id="backToCourses" class="back-button" onclick="backToCourses()">‚Üê Back to Courses</button>
                    <div class="course-title-section">
                        <h2 id="coursePlayerTitle">Course Title</h2>
                        <div class="course-meta">
                            <span id="coursePlayerTier" class="tier-badge"></span>
                            <span id="coursePlayerProgress" class="progress-badge">0% Complete</span>
                        </div>
                    </div>
                </div>

                <div class="course-player-layout">
                    <!-- Video Player Section -->
                    <div class="video-section">
                        <div id="videoPlayerContainer" class="video-player-container">
                            <div id="premiumLockOverlay" class="premium-lock-overlay" style="display: none;">
                                <div class="lock-content">
                                    <div class="lock-icon">üîí</div>
                                    <h3>Premium Content Locked</h3>
                                    <p>This video requires Premium subscription</p>
                                    <button class="cta-button" onclick="showUpgradeModal()">Upgrade to Premium</button>
                                </div>
                            </div>
                            <div id="vimeoPlayer" class="vimeo-player"></div>
                        </div>
                        
                        <div class="video-controls">
                            <h3 id="currentModuleTitle">Select a module to start learning</h3>
                            <div class="video-actions">
                                <button id="prevModule" class="btn-secondary" disabled>Previous</button>
                                <button id="nextModule" class="btn-secondary" disabled>Next</button>
                                <button id="completeModule" class="cta-button" style="display: none;">Mark Complete</button>
                            </div>
                        </div>
                    </div>

                    <!-- Modules Sidebar -->
                    <div class="modules-sidebar">
                        <div class="sidebar-header">
                            <h3>Course Content</h3>
                            <span id="modulesCount">0 modules</span>
                        </div>
                        <div id="modulesList" class="modules-list">
                            <!-- Modules loaded dynamically -->
                        </div>
                        
                        <!-- Downloads Section -->
                        <div class="downloads-section">
                            <h4>Resources & Downloads</h4>
                            <div id="downloadsList" class="downloads-list">
                                <!-- Downloads loaded dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Upgrade Modal -->
    <div id="upgradeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Upgrade to Premium</h3>
                <button class="close-btn" onclick="closeUpgradeModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="upgrade-features">
                    <h4>Premium Benefits:</h4>
                    <ul>
                        <li>‚úÖ Access to all premium videos</li>
                        <li>‚úÖ Downloadable project files</li>
                        <li>‚úÖ Source code access</li>
                        <li>‚úÖ Priority support</li>
                    </ul>
                </div>
                <div class="upgrade-actions">
                    <button class="cta-button full-width" onclick="upgradeToPremium()">Upgrade to Premium - $200</button>
                    <p class="upgrade-note">One-time payment, lifetime access</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced LMS Manager with Video Support
        class LMSManager {
            constructor() {
                this.currentUser = null;
                this.userProfile = null;
                this.courses = [];
                this.userCourses = [];
                this.currentCourse = null;
                this.currentModuleIndex = 0;
                this.modules = [];
                this.vimeoPlayer = null;
                this.init();
            }

            async init() {
                await this.checkAuthState();
                this.setupEventListeners();
            }

            async checkAuthState() {
                const { data: { session } } = await supabase.auth.getSession();
                
                const authRequired = document.getElementById('authRequired');
                const dashboard = document.getElementById('dashboard');

                if (session && session.user) {
                    this.currentUser = session.user;
                    authRequired.style.display = 'none';
                    dashboard.style.display = 'block';
                    
                    // Update UI
                    document.getElementById('userEmail').textContent = session.user.email;
                    document.getElementById('displayEmail').textContent = session.user.email;
                    
                    await this.loadUserData();
                    await this.loadCourses();
                    await this.loadUserCourses();
                    this.renderCourses();
                    
                } else {
                    authRequired.style.display = 'block';
                    dashboard.style.display = 'none';
                }
            }

            async loadUserData() {
                if (!this.currentUser) return;

                try {
                    const { data, error } = await supabase
                        .from('profiles')
                        .select('*')
                        .eq('id', this.currentUser.id)
                        .single();

                    if (error) throw error;
                    this.userProfile = data;
                    
                    // Update UI with user tier
                    const tier = this.userProfile.subscription_tier || 'free';
                    document.getElementById('currentTier').textContent = tier;
                    document.getElementById('displayTier').textContent = tier;
                    document.getElementById('userTier').textContent = tier;
                    
                } catch (error) {
                    console.error('Error loading user profile:', error);
                }
            }

            async loadCourses() {
                try {
                    const { data, error } = await supabase
                        .from('courses')
                        .select('*')
                        .eq('is_active', true)
                        .order('created_at');

                    if (error) throw error;
                    this.courses = data || [];
                } catch (error) {
                    console.error('Error loading courses:', error);
                    this.courses = [];
                }
            }

            async loadUserCourses() {
                if (!this.currentUser) return;

                try {
                    const { data, error } = await supabase
                        .from('user_courses')
                        .select('*')
                        .eq('user_id', this.currentUser.id)
                        .eq('payment_status', 'completed');

                    if (error) throw error;
                    this.userCourses = data || [];
                    
                    document.getElementById('purchasedCount').textContent = this.userCourses.length;
                    
                } catch (error) {
                    console.error('Error loading user courses:', error);
                    this.userCourses = [];
                }
            }

            renderCourses() {
                const container = document.getElementById('coursesContainer');
                if (!container) return;

                container.innerHTML = this.courses.map(course => {
                    const hasAccess = this.hasCourseAccess(course.id);
                    
                    return `
                        <div class="course-card ${hasAccess ? 'unlocked' : 'locked'}">
                            ${hasAccess ? '<div class="access-badge">‚úÖ Access Granted</div>' : ''}
                            <h3>${course.title}</h3>
                            <p>${course.description}</p>
                            <div class="course-meta">
                                <span class="course-tier ${course.required_tier}">${course.required_tier.toUpperCase()} TIER</span>
                                <span class="course-price">$${course.price}</span>
                            </div>
                            <div class="course-actions">
                                ${hasAccess ? 
                                    `<button class="cta-button" onclick="lmsManager.enterCourse('${course.id}')">Start Learning</button>` :
                                    `<button class="cta-button purchase" onclick="lmsManager.purchaseCourse('${course.id}')">Purchase - $${course.price}</button>`
                                }
                            </div>
                        </div>
                    `;
                }).join('');
            }

            hasCourseAccess(courseId) {
                const course = this.courses.find(c => c.id === courseId);
                if (!course) return false;

                // Check if user has purchased the course
                const hasPurchased = this.userCourses.some(uc => uc.course_id === courseId);
                
                // Check if user's tier meets course requirement
                const tierLevel = { 'free': 0, 'basic': 1, 'premium': 2 };
                const userTierLevel = tierLevel[this.userProfile?.subscription_tier] || 0;
                const courseTierLevel = tierLevel[course.required_tier] || 0;
                
                return hasPurchased && userTierLevel >= courseTierLevel;
            }

            async enterCourse(courseId) {
                this.currentCourse = this.courses.find(c => c.id === courseId);
                if (!this.currentCourse) return;

                // Switch to course player view
                document.getElementById('coursesView').style.display = 'none';
                document.getElementById('coursePlayerView').style.display = 'block';

                // Update course info
                document.getElementById('coursePlayerTitle').textContent = this.currentCourse.title;
                document.getElementById('coursePlayerTier').textContent = this.currentCourse.required_tier.toUpperCase();
                document.getElementById('coursePlayerTier').className = `tier-badge ${this.currentCourse.required_tier}`;

                await this.loadCourseModules(courseId);
                await this.loadCourseDownloads(courseId);
                
                // Load first module if available
                if (this.modules.length > 0) {
                    this.currentModuleIndex = 0;
                    this.loadModule(this.currentModuleIndex);
                }
            }

            async loadCourseModules(courseId) {
                try {
                    const { data, error } = await supabase
                        .from('course_modules')
                        .select('*')
                        .eq('course_id', courseId)
                        .order('module_order');

                    if (error) throw error;
                    this.modules = data || [];

                    // Update modules count
                    document.getElementById('modulesCount').textContent = `${this.modules.length} modules`;

                    // Render modules list
                    const modulesList = document.getElementById('modulesList');
                    modulesList.innerHTML = this.modules.map((module, index) => {
                        const isLocked = module.is_premium && this.userProfile?.subscription_tier !== 'premium';
                        const isCurrent = index === this.currentModuleIndex;
                        
                        return `
                            <div class="module-item ${isLocked ? 'locked' : ''} ${isCurrent ? 'active' : ''}" 
                                 onclick="lmsManager.loadModule(${index})">
                                <div class="module-header">
                                    <span class="module-number">${module.module_order.toString().padStart(2, '0')}</span>
                                    <span class="module-title">${module.title} ${isLocked ? 'üîí' : ''}</span>
                                    <span class="module-duration">${module.duration || '10:00'}</span>
                                </div>
                                <div class="module-description">
                                    <p>${module.description}</p>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                } catch (error) {
                    console.error('Error loading modules:', error);
                }
            }

            async loadModule(moduleIndex) {
                if (moduleIndex < 0 || moduleIndex >= this.modules.length) return;

                const module = this.modules[moduleIndex];
                this.currentModuleIndex = moduleIndex;

                // Update UI
                document.querySelectorAll('.module-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelectorAll('.module-item')[moduleIndex].classList.add('active');

                document.getElementById('currentModuleTitle').textContent = module.title;

                // Check if user has access
                const hasAccess = !module.is_premium || this.userProfile?.subscription_tier === 'premium';

                if (hasAccess && module.video_id) {
                    // Hide premium lock, show video
                    document.getElementById('premiumLockOverlay').style.display = 'none';
                    this.loadVimeoVideo(module.video_id);
                } else {
                    // Show premium lock overlay
                    document.getElementById('premiumLockOverlay').style.display = 'flex';
                    if (this.vimeoPlayer) {
                        this.vimeoPlayer.destroy();
                    }
                }

                // Update navigation buttons
                document.getElementById('prevModule').disabled = moduleIndex === 0;
                document.getElementById('nextModule').disabled = moduleIndex === this.modules.length - 1;
                
                // Show complete button if user has access
                document.getElementById('completeModule').style.display = hasAccess ? 'block' : 'none';

                // Track module access
                await this.trackModuleAccess(module.id);
            }

            loadVimeoVideo(videoId) {
                const container = document.getElementById('vimeoPlayer');
                container.innerHTML = ''; // Clear previous player

                this.vimeoPlayer = new Vimeo.Player(container, {
                    id: parseInt(videoId),
                    width: 800,
                    responsive: true,
                    controls: true,
                    // These settings help prevent downloading
                    title: false,
                    portrait: false,
                    byline: false
                });

                // Optional: Add event listeners
                this.vimeoPlayer.on('play', function() {
                    console.log('Video started playing');
                });

                this.vimeoPlayer.on('ended', () => {
                    this.markModuleCompleted(this.modules[this.currentModuleIndex].id);
                });
            }

            async trackModuleAccess(moduleId) {
                try {
                    const { error } = await supabase
                        .from('user_progress')
                        .upsert({
                            user_id: this.currentUser.id,
                            module_id: moduleId,
                            last_accessed: new Date().toISOString()
                        }, {
                            onConflict: 'user_id,module_id'
                        });

                    if (error) throw error;
                } catch (error) {
                    console.error('Error tracking module access:', error);
                }
            }

            async markModuleCompleted(moduleId) {
                try {
                    const { error } = await supabase
                        .from('user_progress')
                        .upsert({
                            user_id: this.currentUser.id,
                            module_id: moduleId,
                            completed: true,
                            progress_percentage: 100,
                            completed_at: new Date().toISOString()
                        }, {
                            onConflict: 'user_id,module_id'
                        });

                    if (error) throw error;
                    
                    // Update UI
                    document.getElementById('completeModule').textContent = '‚úÖ Completed';
                    document.getElementById('completeModule').disabled = true;
                    
                } catch (error) {
                    console.error('Error marking module completed:', error);
                }
            }

            async loadCourseDownloads(courseId) {
                try {
                    const { data, error } = await supabase
                        .from('course_downloads')
                        .select('*')
                        .eq('course_id', courseId)
                        .order('created_at');

                    if (error) throw error;

                    const downloadsList = document.getElementById('downloadsList');
                    downloadsList.innerHTML = (data || []).map(download => {
                        const isLocked = download.is_premium && this.userProfile?.subscription_tier !== 'premium';
                        
                        return `
                            <div class="download-item ${isLocked ? 'locked' : ''}">
                                <div class="download-info">
                                    <h4>${download.title} ${isLocked ? 'üîí' : ''}</h4>
                                    <span class="file-size">${download.file_size || 'N/A'}</span>
                                </div>
                                <div class="download-actions">
                                    ${isLocked ? 
                                        '<button class="btn-secondary" onclick="showUpgradeModal()">Premium Required</button>' :
                                        `<a href="${download.file_url}" target="_blank" class="cta-button">Download</a>`
                                    }
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                } catch (error) {
                    console.error('Error loading downloads:', error);
                }
            }

            setupEventListeners() {
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
                document.getElementById('prevModule').addEventListener('click', () => this.previousModule());
                document.getElementById('nextModule').addEventListener('click', () => this.nextModule());
                document.getElementById('completeModule').addEventListener('click', () => 
                    this.markModuleCompleted(this.modules[this.currentModuleIndex].id)
                );
            }

            previousModule() {
                if (this.currentModuleIndex > 0) {
                    this.loadModule(this.currentModuleIndex - 1);
                }
            }

            nextModule() {
                if (this.currentModuleIndex < this.modules.length - 1) {
                    this.loadModule(this.currentModuleIndex + 1);
                }
            }

            async purchaseCourse(courseId) {
                // Your existing purchase logic
                alert('Purchase functionality to be implemented with Stripe');
            }

            async logout() {
                try {
                    const { error } = await supabase.auth.signOut();
                    if (error) throw error;
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('Logout failed: ' + error.message);
                }
            }
        }

        // Global functions
        function backToCourses() {
            document.getElementById('coursesView').style.display = 'block';
            document.getElementById('coursePlayerView').style.display = 'none';
            if (window.lmsManager.vimeoPlayer) {
                window.lmsManager.vimeoPlayer.destroy();
            }
        }

        function showUpgradeModal() {
            document.getElementById('upgradeModal').classList.add('active');
        }

        function closeUpgradeModal() {
            document.getElementById('upgradeModal').classList.remove('active');
        }

        function upgradeToPremium() {
            alert('Redirecting to premium upgrade payment...');
            // Implement Stripe checkout
            closeUpgradeModal();
        }

        // Initialize LMS Manager
        document.addEventListener('DOMContentLoaded', function() {
            window.lmsManager = new LMSManager();
        });

        // Auth state listener
        supabase.auth.onAuthStateChange((event, session) => {
            if (window.lmsManager) {
                window.lmsManager.checkAuthState();
            }
        });
    </script>
</body>
</html>
