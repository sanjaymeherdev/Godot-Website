<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Courses - Godot 3D MP LMS</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/lms.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Multiple Video Platform APIs -->
    <script src="https://player.vimeo.com/api/player.js"></script>
    <script src="https://fast.wistia.com/assets/external/E-v1.js" async></script>
    <!-- YouTube IFrame API is loaded dynamically -->
</head>
<body>
    <!-- Header (same as before) -->
    <header>
        <!-- Your existing header code -->
    </header>

    <!-- Authentication Required Message -->
    <div id="authRequired" class="auth-required-message">
        <!-- Same as before -->
    </div>

    <!-- Enhanced LMS Dashboard with Multi-Platform Player -->
    <section id="dashboard" class="lms-dashboard" style="display: none;">
        <div class="container">
            <div class="dashboard-header">
                <h1>Godot Multiplayer Courses</h1>
                <div class="user-info">
                    <p>Email: <span id="displayEmail"></span></p>
                    <p>Tier: <strong id="displayTier"></strong></p>
                </div>
            </div>

            <!-- Courses View (same as before) -->
            <div id="coursesView" class="courses-view">
                <!-- Your existing courses grid -->
            </div>

            <!-- Enhanced Course Player View with Multi-Platform Support -->
            <div id="coursePlayerView" class="course-player-view" style="display: none;">
                <div class="course-player-header">
                    <button id="backToCourses" class="back-button" onclick="backToCourses()">‚Üê Back to Courses</button>
                    <div class="course-title-section">
                        <h2 id="coursePlayerTitle">Course Title</h2>
                        <div class="course-meta">
                            <span id="coursePlayerTier" class="tier-badge"></span>
                            <span id="coursePlayerProgress" class="progress-badge">0% Complete</span>
                        </div>
                    </div>
                </div>

                <div class="course-player-layout">
                    <!-- Universal Video Player Section -->
                    <div class="video-section">
                        <div id="videoPlayerContainer" class="video-player-container">
                            <!-- Premium Lock Overlay -->
                            <div id="premiumLockOverlay" class="premium-lock-overlay" style="display: none;">
                                <div class="lock-content">
                                    <div class="lock-icon">üîí</div>
                                    <h3>Premium Content Locked</h3>
                                    <p>This video requires Premium subscription</p>
                                    <button class="cta-button" onclick="showUpgradeModal()">Upgrade to Premium</button>
                                </div>
                            </div>
                            
                            <!-- Platform-Specific Video Players -->
                            <div id="vimeoPlayer" class="video-platform-player" style="display: none;"></div>
                            <div id="wistiaPlayer" class="video-platform-player" style="display: none;"></div>
                            <div id="youtubePlayer" class="video-platform-player" style="display: none;"></div>
                            
                            <!-- Fallback Message -->
                            <div id="noVideoMessage" class="no-video-message" style="display: none;">
                                <p>Video content not available</p>
                            </div>
                        </div>
                        
                        <div class="video-controls">
                            <h3 id="currentModuleTitle">Select a module to start learning</h3>
                            <div class="video-platform-badge" id="videoPlatformBadge" style="display: none;">
                                Powered by <span id="platformName">Platform</span>
                            </div>
                            <div class="video-actions">
                                <button id="prevModule" class="btn-secondary" disabled>Previous</button>
                                <button id="nextModule" class="btn-secondary" disabled>Next</button>
                                <button id="completeModule" class="cta-button" style="display: none;">Mark Complete</button>
                            </div>
                        </div>
                    </div>

                    <!-- Modules Sidebar (same as before) -->
                    <div class="modules-sidebar">
                        <!-- Your existing modules list -->
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Upgrade Modal (same as before) -->
    <div id="upgradeModal" class="modal">
        <!-- Your existing upgrade modal -->
    </div>

    <script>
        // Enhanced LMS Manager with Multi-Platform Video Support
        class LMSManager {
            constructor() {
                this.currentUser = null;
                this.userProfile = null;
                this.courses = [];
                this.userCourses = [];
                this.currentCourse = null;
                this.currentModuleIndex = 0;
                this.modules = [];
                this.currentPlayer = null;
                this.currentPlatform = null;
                this.youtubeAPIReady = false;
                this.init();
            }

            async init() {
                await this.checkAuthState();
                this.setupEventListeners();
                this.loadYouTubeAPI(); // Load YouTube API dynamically
            }

            // Load YouTube IFrame API
            loadYouTubeAPI() {
                const tag = document.createElement('script');
                tag.src = "https://www.youtube.com/iframe_api";
                const firstScriptTag = document.getElementsByTagName('script')[0];
                firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
            }

            // YouTube API ready callback
            onYouTubeAPIReady() {
                this.youtubeAPIReady = true;
                console.log('YouTube API ready');
            }

            async checkAuthState() {
                const { data: { session } } = await supabase.auth.getSession();
                
                if (session && session.user) {
                    this.currentUser = session.user;
                    document.getElementById('authRequired').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    
                    document.getElementById('userEmail').textContent = session.user.email;
                    document.getElementById('displayEmail').textContent = session.user.email;
                    
                    await this.loadUserData();
                    await this.loadCourses();
                    await this.loadUserCourses();
                    this.renderCourses();
                    
                } else {
                    document.getElementById('authRequired').style.display = 'block';
                    document.getElementById('dashboard').style.display = 'none';
                }
            }

            // ... (keep your existing loadUserData, loadCourses, loadUserCourses, renderCourses methods)

            async enterCourse(courseId) {
                this.currentCourse = this.courses.find(c => c.id === courseId);
                if (!this.currentCourse) return;

                // Switch to course player view
                document.getElementById('coursesView').style.display = 'none';
                document.getElementById('coursePlayerView').style.display = 'block';

                // Update course info
                document.getElementById('coursePlayerTitle').textContent = this.currentCourse.title;
                document.getElementById('coursePlayerTier').textContent = this.currentCourse.required_tier.toUpperCase();
                document.getElementById('coursePlayerTier').className = `tier-badge ${this.currentCourse.required_tier}`;

                await this.loadCourseModules(courseId);
                await this.loadCourseDownloads(courseId);
                
                // Load first module if available
                if (this.modules.length > 0) {
                    this.currentModuleIndex = 0;
                    this.loadModule(this.currentModuleIndex);
                }
            }

            async loadModule(moduleIndex) {
                if (moduleIndex < 0 || moduleIndex >= this.modules.length) return;

                const module = this.modules[moduleIndex];
                this.currentModuleIndex = moduleIndex;

                // Update UI
                document.querySelectorAll('.module-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelectorAll('.module-item')[moduleIndex].classList.add('active');

                document.getElementById('currentModuleTitle').textContent = module.title;

                // Check if user has access
                const hasAccess = !module.is_premium || this.userProfile?.subscription_tier === 'premium';

                if (hasAccess && module.video_id) {
                    // Hide premium lock, show video
                    document.getElementById('premiumLockOverlay').style.display = 'none';
                    this.loadVideo(module);
                } else {
                    // Show premium lock overlay
                    document.getElementById('premiumLockOverlay').style.display = 'flex';
                    this.destroyCurrentPlayer();
                }

                // Update navigation buttons
                document.getElementById('prevModule').disabled = moduleIndex === 0;
                document.getElementById('nextModule').disabled = moduleIndex === this.modules.length - 1;
                
                // Show complete button if user has access
                document.getElementById('completeModule').style.display = hasAccess ? 'block' : 'none';

                // Track module access
                await this.trackModuleAccess(module.id);
            }

            loadVideo(module) {
                // Destroy any existing player first
                this.destroyCurrentPlayer();

                // Hide all video players
                document.querySelectorAll('.video-platform-player').forEach(player => {
                    player.style.display = 'none';
                });
                document.getElementById('noVideoMessage').style.display = 'none';

                const platform = module.video_platform || 'vimeo';
                this.currentPlatform = platform;

                // Show platform badge
                const badge = document.getElementById('videoPlatformBadge');
                const platformName = document.getElementById('platformName');
                badge.style.display = 'block';
                platformName.textContent = platform.charAt(0).toUpperCase() + platform.slice(1);

                switch (platform) {
                    case 'vimeo':
                        this.loadVimeoVideo(module.video_id);
                        break;
                    case 'wistia':
                        this.loadWistiaVideo(module.video_id);
                        break;
                    case 'youtube':
                        this.loadYouTubeVideo(module.video_id);
                        break;
                    default:
                        console.error('Unsupported video platform:', platform);
                        document.getElementById('noVideoMessage').style.display = 'block';
                }
            }

            loadVimeoVideo(videoId) {
                const container = document.getElementById('vimeoPlayer');
                container.style.display = 'block';
                container.innerHTML = '';

                this.currentPlayer = new Vimeo.Player(container, {
                    id: parseInt(videoId),
                    width: 800,
                    responsive: true,
                    controls: true,
                    // Security settings
                    title: false,
                    portrait: false,
                    byline: false,
                    // Prevent right-click and downloads
                    transparent: false
                });

                this.currentPlayer.on('play', () => {
                    console.log('Vimeo video started playing');
                });

                this.currentPlayer.on('ended', () => {
                    this.markModuleCompleted(this.modules[this.currentModuleIndex].id);
                });
            }

            loadWistiaVideo(videoId) {
                const container = document.getElementById('wistiaPlayer');
                container.style.display = 'block';
                container.innerHTML = '';

                // Wistia security features
                window._wq = window._wq || [];
                _wq.push({
                    id: videoId,
                    options: {
                        // Security settings
                        copyLinkAndThumbnailEnabled: false,
                        playbar: true,
                        volumeControl: true,
                        fullscreenButton: true,
                        playButton: true,
                        controlsVisibleOnLoad: false,
                        // Prevent downloads
                        videoFoam: true
                    },
                    onReady: (video) => {
                        this.currentPlayer = video;
                        
                        video.bind("play", () => {
                            console.log('Wistia video started playing');
                        });

                        video.bind("end", () => {
                            this.markModuleCompleted(this.modules[this.currentModuleIndex].id);
                        });
                    }
                });

                // Create Wistia embed
                const wistiaEmbed = document.createElement('div');
                wistiaEmbed.className = `wistia_embed wistia_async_${videoId}`;
                wistiaEmbed.style.width = '100%';
                wistiaEmbed.style.height = '450px';
                container.appendChild(wistiaEmbed);
            }

            loadYouTubeVideo(videoId) {
                if (!this.youtubeAPIReady) {
                    console.warn('YouTube API not ready yet, retrying...');
                    setTimeout(() => this.loadYouTubeVideo(videoId), 1000);
                    return;
                }

                const container = document.getElementById('youtubePlayer');
                container.style.display = 'block';
                container.innerHTML = '';

                this.currentPlayer = new YT.Player(container, {
                    height: '450',
                    width: '800',
                    videoId: videoId,
                    playerVars: {
                        // Security and UX settings
                        'modestbranding': 1,
                        'rel': 0,
                        'showinfo': 0,
                        'controls': 1,
                        'disablekb': 0, // Allow keyboard controls
                        'fs': 1, // Allow fullscreen
                        // Try to prevent downloads (limited effectiveness)
                        'origin': window.location.origin
                    },
                    events: {
                        'onReady': (event) => {
                            console.log('YouTube player ready');
                        },
                        'onStateChange': (event) => {
                            if (event.data === YT.PlayerState.PLAYING) {
                                console.log('YouTube video started playing');
                            }
                            if (event.data === YT.PlayerState.ENDED) {
                                this.markModuleCompleted(this.modules[this.currentModuleIndex].id);
                            }
                        }
                    }
                });
            }

            destroyCurrentPlayer() {
                if (this.currentPlayer) {
                    switch (this.currentPlatform) {
                        case 'vimeo':
                            this.currentPlayer.destroy().then(() => {
                                console.log('Vimeo player destroyed');
                            }).catch(error => {
                                console.log('Vimeo player destruction error:', error);
                            });
                            break;
                        case 'wistia':
                            if (this.currentPlayer.remove) {
                                this.currentPlayer.remove();
                            }
                            break;
                        case 'youtube':
                            this.currentPlayer.destroy();
                            break;
                    }
                    this.currentPlayer = null;
                }
                
                // Clear all video containers
                document.querySelectorAll('.video-platform-player').forEach(container => {
                    container.innerHTML = '';
                    container.style.display = 'none';
                });
                document.getElementById('videoPlatformBadge').style.display = 'none';
            }

            // ... (keep your existing trackModuleAccess, markModuleCompleted, 
            // loadCourseDownloads, setupEventListeners, navigation methods)

            async purchaseCourse(courseId) {
                // Your existing purchase logic
                alert('Purchase functionality to be implemented with Stripe');
            }

            async logout() {
                try {
                    this.destroyCurrentPlayer();
                    const { error } = await supabase.auth.signOut();
                    if (error) throw error;
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('Logout failed: ' + error.message);
                }
            }
        }

        // Global YouTube API callback
        function onYouTubeIframeAPIReady() {
            if (window.lmsManager) {
                window.lmsManager.onYouTubeAPIReady();
            } else {
                // Fallback if LMS manager isn't ready yet
                window.youtubeAPIReady = true;
            }
        }

        // Global functions (same as before)
        function backToCourses() {
            document.getElementById('coursesView').style.display = 'block';
            document.getElementById('coursePlayerView').style.display = 'none';
            if (window.lmsManager) {
                window.lmsManager.destroyCurrentPlayer();
            }
        }

        function showUpgradeModal() {
            document.getElementById('upgradeModal').classList.add('active');
        }

        function closeUpgradeModal() {
            document.getElementById('upgradeModal').classList.remove('active');
        }

        function upgradeToPremium() {
            alert('Redirecting to premium upgrade payment...');
            closeUpgradeModal();
        }

        // Initialize LMS Manager
        document.addEventListener('DOMContentLoaded', function() {
            window.lmsManager = new LMSManager();
        });

        // Auth state listener
        supabase.auth.onAuthStateChange((event, session) => {
            if (window.lmsManager) {
                window.lmsManager.checkAuthState();
            }
        });
    </script>
</body>
</html>
