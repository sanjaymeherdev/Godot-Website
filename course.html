<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Courses - Godot 3D MP LMS</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/lms.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <nav>
                <div class="logo">GODOT 3D MP</div>
                
                <!-- Desktop Navigation -->
                <div class="nav-links">
                    <a href="index.html">Home</a>
                    <a href="#dashboard">Dashboard</a>
                    <a href="#progress">My Progress</a>
                </div>
                
                <!-- Desktop User Menu -->
                <div class="user-menu">
                    <span id="userEmail" class="user-email"></span>
                    <span id="userTier" class="user-tier"></span>
                    <button id="logoutBtn" class="cta-button logout-btn">Logout</button>
                </div>
                
                <!-- Mobile Menu Button -->
                <button class="mobile-menu-btn" id="mobileMenuBtn">‚ò∞</button>
            </nav>
        </div>
        
        <!-- Mobile Menu -->
        <div class="mobile-menu" id="mobileMenu">
            <div class="mobile-menu-header">
                <div class="mobile-menu-logo">GODOT 3D MP</div>
                <button class="mobile-close-btn" id="mobileCloseBtn">‚úï</button>
            </div>
            
            <div class="mobile-nav-links">
                <a href="index.html" onclick="closeMobileMenu()">Home</a>
                <a href="#dashboard" onclick="closeMobileMenu()">Dashboard</a>
                <a href="#progress" onclick="closeMobileMenu()">My Progress</a>
                
                <!-- Mobile User Info -->
                <div class="mobile-user-menu">
                    <div class="mobile-user-email" id="mobileUserEmail"></div>
                    <div class="mobile-user-tier" id="mobileUserTier"></div>
                    <button class="mobile-logout-btn" id="mobileLogoutBtn">Logout</button>
                </div>
            </div>
        </div>
        
        <!-- Mobile Menu Overlay -->
        <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>
    </header>

    <!-- Authentication Required Message -->
    <div id="authRequired" class="auth-required-message">
        <div class="container">
            <div class="auth-message">
                <h2>Authentication Required</h2>
                <p>Please log in to access the course content.</p>
                <a href="login.html" class="cta-button">Login / Sign Up</a>
            </div>
        </div>
    </div>

    <!-- LMS Dashboard -->
    <section id="dashboard" class="lms-dashboard" style="display: none;">
        <div class="container">
            <div class="dashboard-header">
                <h1>Godot Multiplayer Courses</h1>
                <div class="user-info">
                    <p>Email: <span id="displayEmail"></span></p>
                    <p>Tier: <strong id="displayTier"></strong></p>
                    <p>User ID: <span id="displayUserId"></span></p>
                </div>
            </div>

            <!-- Courses View -->
            <div id="coursesView" class="courses-view">
                <h2>Available Courses</h2>
                <div class="subscription-info">
                    <p>Current Tier: <strong id="currentTier">Free</strong></p>
                    <p>Purchased Courses: <strong id="purchasedCount">0</strong></p>
                </div>
                <div id="coursesContainer" class="courses-grid">
                    <!-- Courses will be loaded here -->
                </div>
            </div>

            <!-- Course Details View -->
            <div id="courseDetailsView" class="course-details-view" style="display: none;">
                <button id="backToCourses" class="back-button" onclick="backToCourses()">‚Üê Back to Courses</button>
                <div class="course-details-container">
                    <div class="course-header-details">
                        <h2 id="courseDetailTitle"></h2>
                        <p id="courseDetailDescription"></p>
                        <div class="course-meta-details">
                            <span class="course-tier-badge" id="courseDetailTier"></span>
                            <span class="course-price" id="courseDetailPrice"></span>
                        </div>
                    </div>

                    <div class="course-content">
                        <!-- Modules Section -->
                        <div class="modules-section">
                            <h3>Course Content</h3>
                            <div id="modulesList" class="modules-list">
                                <!-- Modules will be loaded here -->
                            </div>
                        </div>

                        <!-- Downloads Section -->
                        <div class="downloads-section">
                            <h3>Resources & Downloads</h3>
                            <div id="downloadsList" class="downloads-list">
                                <!-- Downloads will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Progress Overview -->
    <section id="progress" class="progress-overview" style="display: none;">
        <div class="container">
            <h2>Your Learning Progress</h2>
            <div class="progress-grid">
                <div class="progress-card">
                    <h3>Course Completion</h3>
                    <div class="progress-circle">
                        <svg width="120" height="120" viewBox="0 0 120 120">
                            <circle cx="60" cy="60" r="54" fill="none" stroke="#333" stroke-width="8"/>
                            <circle id="completionCircle" cx="60" cy="60" r="54" fill="none" stroke="#ff6b35" stroke-width="8" stroke-dasharray="339.292" stroke-dashoffset="339.292" transform="rotate(-90 60 60)"/>
                        </svg>
                        <span id="completionPercent" class="completion-percent">0%</span>
                    </div>
                </div>

                <div class="progress-card">
                    <h3>Your Subscription</h3>
                    <div class="subscription-status">
                        <div class="tier-info">
                            <span class="tier-label">Current Tier:</span>
                            <span id="progressTier" class="tier-value">Free</span>
                        </div>
                        <div class="upgrade-options">
                            <!-- Upgrade options will be dynamically loaded -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

      <script>
        // Mobile Menu Functionality (same as before)
        // ...

        // Supabase Configuration
        const SUPABASE_URL = 'https://usooclimfkregwrtmdki.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVzb29jbGltZmtyZWd3cnRtZGtpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0Nzg2MTEsImV4cCI6MjA3OTA1NDYxMX0.43Wy4GS_DSx4IWXmFKg5wz0YwmV7lsadWcm0ysCcfe0';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        class LMSManager {
            constructor() {
                this.currentUser = null;
                this.userProfile = null;
                this.courses = [];
                this.userCourses = [];
                this.currentCourse = null;
                this.init();
            }

            async init() {
                await this.checkAuthState();
                this.setupEventListeners();
            }

            async checkAuthState() {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                const authRequired = document.getElementById('authRequired');
                const dashboard = document.getElementById('dashboard');
                const progressSection = document.getElementById('progress');
                const userEmail = document.getElementById('userEmail');
                const displayEmail = document.getElementById('displayEmail');
                const displayUserId = document.getElementById('displayUserId');
                const mobileUserEmail = document.getElementById('mobileUserEmail');

                if (session && session.user) {
                    this.currentUser = session.user;
                    authRequired.style.display = 'none';
                    dashboard.style.display = 'block';
                    progressSection.style.display = 'block';
                    
                    userEmail.textContent = session.user.email;
                    displayEmail.textContent = session.user.email;
                    displayUserId.textContent = session.user.id.substring(0, 8) + '...';
                    mobileUserEmail.textContent = session.user.email;
                    
                    await this.loadUserData();
                    await this.loadCourses();
                    await this.loadUserCourses();
                    this.renderCourses();
                    this.updateProgress();
                    this.renderUpgradeOptions();
                    
                } else {
                    authRequired.style.display = 'block';
                    dashboard.style.display = 'none';
                    progressSection.style.display = 'none';
                }
            }

            async loadUserData() {
    if (!this.currentUser) return;

    try {
        // First, get the profile
        const { data, error } = await supabase
            .from('profiles')
            .select('*')
            .eq('id', this.currentUser.id)
            .single();

        if (error) {
            // Profile not found - create new one with email from Auth
            console.log('Profile not found, creating new profile...');
            await this.createUserProfile();
            return;
        }

        // Profile exists - check if email is null and update if needed
        if (!data.email || data.email === null || data.email === '') {
            console.log('Email is null in profile, updating from Auth...');
            await this.updateProfileEmail();
            return;
        }

        this.userProfile = data;
        this.updateTierUI();
        
    } catch (error) {
        console.error('Error loading user profile:', error);
        this.setDefaultTier();
    }
}

async createUserProfile() {
    try {
        const { data, error } = await supabase
            .from('profiles')
            .insert([{
                id: this.currentUser.id,
                email: this.currentUser.email, // Get email from Auth user
                subscription_tier: 'free',
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            }])
            .select()
            .single();

        if (error) throw error;
        
        this.userProfile = data;
        this.updateTierUI();
        console.log('‚úÖ New profile created with email:', this.userProfile.email);
        
    } catch (error) {
        console.error('Error creating user profile:', error);
        this.setDefaultTier();
    }
}

async updateProfileEmail() {
    try {
        // Update the profile with email from Auth user
        const { data, error } = await supabase
            .from('profiles')
            .update({
                email: this.currentUser.email, // Get email from Auth user
                updated_at: new Date().toISOString()
            })
            .eq('id', this.currentUser.id)
            .select()
            .single();

        if (error) throw error;
        
        this.userProfile = data;
        this.updateTierUI();
        console.log('‚úÖ Profile email updated:', this.userProfile.email);
        
    } catch (error) {
        console.error('Error updating profile email:', error);
        // Even if update fails, try to load the profile without email
        await this.loadProfileWithoutEmail();
    }
}

async loadProfileWithoutEmail() {
    try {
        // Load profile even if email update failed
        const { data, error } = await supabase
            .from('profiles')
            .select('*')
            .eq('id', this.currentUser.id)
            .single();

        if (error) throw error;
        
        this.userProfile = data;
        this.updateTierUI();
        console.log('‚úÖ Profile loaded (email may be null):', this.userProfile);
        
    } catch (error) {
        console.error('Error loading profile:', error);
        this.setDefaultTier();
    }
}
            updateTierUI() {
                if (!this.userProfile) {
                    this.setDefaultTier();
                    return;
                }

                const userTier = this.userProfile.subscription_tier?.trim();
                const displayTier = userTier && userTier !== '' ? userTier : 'free';
                
                // Update all tier displays
                document.getElementById('currentTier').textContent = displayTier;
                document.getElementById('displayTier').textContent = displayTier;
                document.getElementById('progressTier').textContent = displayTier;
                document.getElementById('userTier').textContent = displayTier;
                document.getElementById('mobileUserTier').textContent = displayTier;
            }

            setDefaultTier() {
                const defaultTier = 'free';
                document.getElementById('currentTier').textContent = defaultTier;
                document.getElementById('displayTier').textContent = defaultTier;
                document.getElementById('progressTier').textContent = defaultTier;
                document.getElementById('userTier').textContent = defaultTier;
                document.getElementById('mobileUserTier').textContent = defaultTier;
                
                // Also set it in the userProfile object
                this.userProfile = this.userProfile || {};
                this.userProfile.subscription_tier = defaultTier;
            }

            async loadCourses() {
                try {
                    const { data, error } = await supabase
                        .from('courses')
                        .select('*')
                        .eq('is_active', true)
                        .order('created_at');

                    if (error) throw error;
                    this.courses = data || [];
                } catch (error) {
                    console.error('Error loading courses:', error);
                    this.courses = [];
                }
            }

            async loadUserCourses() {
                if (!this.currentUser) return;

                try {
                    const { data, error } = await supabase
                        .from('user_courses')
                        .select('*')
                        .eq('user_id', this.currentUser.id)
                        .eq('payment_status', 'completed');

                    if (error) throw error;
                    this.userCourses = data || [];
                    
                    document.getElementById('purchasedCount').textContent = this.userCourses.length;
                    
                } catch (error) {
                    console.error('Error loading user courses:', error);
                    this.userCourses = [];
                }
            }

            setupEventListeners() {
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
                document.getElementById('mobileLogoutBtn').addEventListener('click', () => this.logout());
            }

            renderCourses() {
                const container = document.getElementById('coursesContainer');
                if (!container) return;

                container.innerHTML = this.courses.map(course => {
                    const hasAccess = this.hasCourseAccess(course.id);
                    const canUpgrade = this.canUpgradeToCourse(course);
                    
                    return `
                        <div class="course-card ${hasAccess ? 'unlocked' : 'locked'}">
                            ${hasAccess ? '<div class="access-badge">‚úÖ Access Granted</div>' : ''}
                            <h3>${course.title}</h3>
                            <p>${course.description}</p>
                            <div class="course-meta">
                                <span class="course-tier">${course.required_tier.toUpperCase()} TIER</span>
                                <span class="course-price">${this.getCoursePriceDisplay(course.required_tier)}</span>
                            </div>
                            <div class="course-actions">
                                ${hasAccess ? 
                                    `<button class="cta-button" onclick="lmsManager.viewCourse('${course.id}')">Access Course</button>` :
                                    (canUpgrade ?
                                        `<button class="cta-button upgrade" onclick="lmsManager.upgradeToCourse('${course.id}')">Upgrade to ${course.required_tier.toUpperCase()}</button>` :
                                        `<button class="cta-button disabled" disabled>Upgrade Required</button>`
                                    )
                                }
                            </div>
                        </div>
                    `;
                }).join('');
            }

            getCoursePriceDisplay(tier) {
                const priceMap = {
                    'free': 'FREE',
                    'basic': 'BASIC',
                    'premium': 'PREMIUM'
                };
                return priceMap[tier] || 'PREMIUM';
            }

            hasCourseAccess(courseId) {
                const course = this.courses.find(c => c.id === courseId);
                if (!course) return false;

                const tierLevel = { 'free': 0, 'basic': 1, 'premium': 2 };
                const userTierLevel = tierLevel[this.userProfile?.subscription_tier] || 0;
                const courseTierLevel = tierLevel[course.required_tier] || 2;
                
                return userTierLevel >= courseTierLevel;
            }

            canUpgradeToCourse(course) {
                const tierLevel = { 'free': 0, 'basic': 1, 'premium': 2 };
                const userTierLevel = tierLevel[this.userProfile?.subscription_tier] || 0;
                const courseTierLevel = tierLevel[course.required_tier] || 2;
                
                return courseTierLevel > userTierLevel;
            }

            async viewCourse(courseId) {
                this.currentCourse = this.courses.find(c => c.id === courseId);
                if (!this.currentCourse) return;

                if (!this.hasCourseAccess(courseId)) {
                    alert('‚ùå You need to upgrade your tier to access this course');
                    return;
                }

                document.getElementById('coursesView').style.display = 'none';
                document.getElementById('courseDetailsView').style.display = 'block';

                document.getElementById('courseDetailTitle').textContent = this.currentCourse.title;
                document.getElementById('courseDetailDescription').textContent = this.currentCourse.description;
                document.getElementById('courseDetailTier').textContent = this.currentCourse.required_tier.toUpperCase() + ' TIER';
                document.getElementById('courseDetailPrice').textContent = this.getCoursePriceDisplay(this.currentCourse.required_tier);

                await this.loadCourseModules(courseId);
                await this.loadCourseDownloads(courseId);
            }

            async loadCourseModules(courseId) {
                try {
                    const { data, error } = await supabase
                        .from('course_modules')
                        .select('*')
                        .eq('course_id', courseId)
                        .order('module_order');

                    if (error) throw error;

                    const modulesList = document.getElementById('modulesList');
                    modulesList.innerHTML = (data || []).map(module => {
                        const isLocked = module.is_premium && this.userProfile?.subscription_tier !== 'premium';
                        
                        return `
                            <div class="module-item ${isLocked ? 'locked' : ''}">
                                <div class="module-header">
                                    <span class="module-number">${module.module_order.toString().padStart(2, '0')}</span>
                                    <span class="module-title">${module.title} ${isLocked ? 'üîí' : ''}</span>
                                    <span class="module-duration">${module.duration}</span>
                                    <span class="module-status status-${isLocked ? 'locked' : 'unlocked'}">
                                        ${isLocked ? 'PREMIUM CONTENT' : 'AVAILABLE'}
                                    </span>
                                </div>
                                <div class="module-description">
                                    <p>${module.description}</p>
                                    ${isLocked ? 
                                        '<div class="premium-lock-message">Upgrade to Premium to access this content</div>' : 
                                        (module.video_url ? 
                                            `<a href="${module.video_url}" target="_blank" class="video-link">Watch Video ‚Üí</a>` : 
                                            '<em>Content coming soon</em>'
                                        )
                                    }
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                } catch (error) {
                    console.error('Error loading modules:', error);
                }
            }

            async loadCourseDownloads(courseId) {
                try {
                    const { data, error } = await supabase
                        .from('course_downloads')
                        .select('*')
                        .eq('course_id', courseId)
                        .order('created_at');

                    if (error) throw error;

                    const downloadsList = document.getElementById('downloadsList');
                    downloadsList.innerHTML = (data || []).map(download => {
                        const isLocked = download.is_premium && this.userProfile?.subscription_tier !== 'premium';
                        
                        return `
                            <div class="download-item ${isLocked ? 'locked' : ''}">
                                <div class="download-info">
                                    <h4>${download.title} ${isLocked ? 'üîí' : ''}</h4>
                                    <span class="file-size">${download.file_size}</span>
                                </div>
                                <div class="download-actions">
                                    ${isLocked ? 
                                        '<button class="btn-secondary" disabled>Premium Required</button>' :
                                        `<a href="${download.file_url}" target="_blank" class="cta-button">Download</a>`
                                    }
                                </div>
                                ${isLocked ? 
                                    '<div class="premium-lock-message">Upgrade to Premium to download this resource</div>' : 
                                    ''
                                }
                            </div>
                        `;
                    }).join('');
                    
                } catch (error) {
                    console.error('Error loading downloads:', error);
                }
            }

            upgradeToCourse(courseId) {
                const course = this.courses.find(c => c.id === courseId);
                if (!course) return;

                const phoneNumber = '7504704502';
                const message = `Hello! I'm interested in upgrading to the ${course.required_tier.toUpperCase()} tier for the course: "${course.title}". My email: ${this.currentUser.email}`;
                
                const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                
                alert(`üì± Opening WhatsApp to request ${course.required_tier.toUpperCase()} tier upgrade for "${course.title}"`);
            }

            renderUpgradeOptions() {
                const upgradeContainer = document.querySelector('.upgrade-options');
                if (!upgradeContainer) return;

                const userTier = this.userProfile?.subscription_tier || 'free';
                
                if (userTier === 'free') {
                    upgradeContainer.innerHTML = `
                        <button class="upgrade-btn basic" onclick="lmsManager.requestUpgrade('basic')">
                            Upgrade to Basic - Contact via WhatsApp
                        </button>
                        <button class="upgrade-btn premium" onclick="lmsManager.requestUpgrade('premium')">
                            Upgrade to Premium - Contact via WhatsApp
                        </button>
                    `;
                } else if (userTier === 'basic') {
                    upgradeContainer.innerHTML = `
                        <button class="upgrade-btn premium" onclick="lmsManager.requestUpgrade('premium')">
                            Upgrade to Premium - Contact via WhatsApp
                        </button>
                    `;
                } else if (userTier === 'premium') {
                    upgradeContainer.innerHTML = `
                        <div class="max-tier-message">
                            ‚úÖ You are already at the highest tier (Premium)
                        </div>
                    `;
                }
            }

            requestUpgrade(tier) {
                const phoneNumber = '7504704502';
                const message = `Hello! I'd like to upgrade to ${tier.toUpperCase()} tier. My email: ${this.currentUser.email}`;
                
                const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                
                alert(`üì± Opening WhatsApp to request ${tier.toUpperCase()} tier upgrade`);
            }

            async logout() {
                try {
                    const { error } = await supabase.auth.signOut();
                    if (error) throw error;
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('Logout failed: ' + error.message);
                }
            }

            updateProgress() {
                const progress = 25;
                const circle = document.getElementById('completionCircle');
                const percent = document.getElementById('completionPercent');
                
                const circumference = 339.292;
                const offset = circumference - (progress / 100) * circumference;
                
                circle.style.strokeDashoffset = offset;
                percent.textContent = progress + '%';
            }
        }

        function backToCourses() {
            document.getElementById('coursesView').style.display = 'block';
            document.getElementById('courseDetailsView').style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', function() {
            window.lmsManager = new LMSManager();
        });

        supabase.auth.onAuthStateChange((event, session) => {
            if (window.lmsManager) {
                window.lmsManager.checkAuthState();
            }
        });
    </script>
</body>
</html>
