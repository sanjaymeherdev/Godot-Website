<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Coding Assistant - Godot Assets Marketplace</title>
    <style>
        /* Import your existing styles */
        :root {
            --primary: #ff6b35;
            --secondary: #2a2a2a;
            --accent: #00d9ff;
            --light: #f8f9fa;
            --dark: #1a1a1a;
            --success: #28a745;
            --error: #dc3545;
            --code-bg: #1e1e1e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--light);
            background: linear-gradient(135deg, var(--dark) 0%, #2d1b69 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header - Reusing your existing header styles */
        header {
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(10px);
            position: fixed;
            width: 100%;
            z-index: 1000;
            border-bottom: 2px solid var(--primary);
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary);
        }

        .nav-links {
            display: flex;
            gap: 2rem;
        }

        .nav-links a {
            color: var(--light);
            text-decoration: none;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: var(--primary);
        }

        .cta-button {
            background: var(--primary);
            color: white;
            padding: 0.8rem 2rem;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            display: inline-block;
        }

        .cta-button:hover {
            background: #e55a2b;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        }

        /* Page Hero */
        .page-hero {
            padding: 150px 0 50px;
            text-align: center;
            background: radial-gradient(circle at center, #2d1b69 0%, var(--dark) 70%);
        }

        .page-hero h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .page-hero p {
            font-size: 1.2rem;
            max-width: 800px;
            margin: 0 auto 2rem;
            color: #ccc;
        }

        /* API Configuration Section */
        .api-config {
            background: rgba(255, 107, 53, 0.1);
            border: 1px solid rgba(255, 107, 53, 0.3);
            border-radius: 10px;
            padding: 1.5rem;
            margin: 2rem auto;
            max-width: 800px;
        }

        .api-config h3 {
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .api-input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        @media (max-width: 768px) {
            .api-input-group {
                grid-template-columns: 1fr;
            }
        }

        .api-input {
            width: 100%;
            padding: 0.8rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            color: var(--light);
            font-size: 1rem;
        }

        .api-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .api-status.online {
            color: var(--success);
        }

        .api-status.offline {
            color: var(--error);
        }

        /* AI Assistant Container */
        .ai-assistant-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin: 2rem auto;
            overflow: hidden;
            min-height: 600px;
        }

        /* Tabs Navigation */
        .ai-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.08);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            overflow-x: auto;
        }

        .ai-tab {
            padding: 1rem 2rem;
            background: transparent;
            border: none;
            color: var(--light);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
            position: relative;
        }

        .ai-tab:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .ai-tab.active {
            background: rgba(255, 107, 53, 0.15);
            color: var(--primary);
        }

        .ai-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
        }

        /* Tab Content */
        .ai-tab-content {
            display: none;
            padding: 2rem;
            min-height: 500px;
        }

        .ai-tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Split Container Layout */
        .split-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            height: 100%;
        }

        @media (max-width: 768px) {
            .split-container {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: 1.5rem;
            height: 100%;
        }

        .panel-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel-header h3 {
            color: var(--accent);
            font-size: 1.3rem;
        }

        /* Text Areas */
        textarea, pre {
            width: 100%;
            min-height: 300px;
            background: var(--code-bg);
            color: #e0e0e0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            white-space: pre-wrap;
            line-height: 1.5;
            overflow: auto;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        pre {
            margin: 0;
            overflow-x: auto;
        }

        /* Button Groups */
        .button-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1.5rem;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #e55a2b;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-accent {
            background: var(--accent);
            color: var(--dark);
        }

        .btn-accent:hover {
            background: #00c4e6;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Status Bar */
        .status-bar {
            background: rgba(0, 0, 0, 0.3);
            padding: 0.8rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
            color: #aaa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Options */
        .options-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        select, input {
            width: 100%;
            padding: 0.8rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            color: var(--light);
            font-size: 1rem;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Results Display */
        .results {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 1.5rem;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .results h4 {
            color: var(--accent);
            margin-bottom: 1rem;
        }

        /* Chat Interface */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 500px;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .chat-message {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 8px;
            max-width: 80%;
        }

        .chat-message.user {
            background: rgba(255, 107, 53, 0.15);
            margin-left: auto;
            border: 1px solid rgba(255, 107, 53, 0.3);
        }

        .chat-message.ai {
            background: rgba(0, 217, 255, 0.1);
            margin-right: auto;
            border: 1px solid rgba(0, 217, 255, 0.2);
        }

        .chat-input-container {
            display: flex;
            gap: 1rem;
        }

        .chat-input {
            flex: 1;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--light);
            font-size: 1rem;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Code Syntax Highlighting */
        .code-keyword { color: #569cd6; }
        .code-string { color: #ce9178; }
        .code-comment { color: #6a9955; }
        .code-function { color: #dcdcaa; }
        .code-number { color: #b5cea8; }
        .code-operator { color: #d4d4d4; }

        /* Error Messages */
        .error-message {
            color: var(--error);
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .success-message {
            color: var(--success);
            background: rgba(40, 167, 69, 0.1);
            border: 1px solid rgba(40, 167, 69, 0.3);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        /* Footer */
        footer {
            background: var(--dark);
            padding: 3rem 0;
            text-align: center;
            border-top: 2px solid var(--primary);
            margin-top: 4rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .page-hero {
                padding: 130px 0 30px;
            }

            .page-hero h1 {
                font-size: 2.2rem;
            }

            .ai-tabs {
                flex-wrap: wrap;
            }

            .ai-tab {
                padding: 0.8rem 1.5rem;
                font-size: 0.9rem;
            }

            .ai-tab-content {
                padding: 1.5rem;
            }

            .panel {
                padding: 1rem;
            }
        }

        @media (max-width: 480px) {
            .page-hero h1 {
                font-size: 1.8rem;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <nav>
                <div class="logo">GODOT ASSETS</div>
                
                <div class="nav-links">
                    <a href="index.html">Home</a>
                    <a href="ai-assistant.html" class="active">AI Assistant</a>
                    <a href="scripts.html">Scripts</a>
                    <a href="minicourses.html">Mini Courses</a>
                    <a href="services.html">Services</a>
                </div>
                
                <a href="scripts.html" class="cta-button">Get Assets</a>
            </nav>
        </div>
    </header>

    <!-- Page Hero -->
    <section class="page-hero">
        <div class="container">
            <h1>AI Coding Assistant</h1>
            <p>Powered by Gemini & Groq APIs - Intelligent code analysis, generation, and optimization for Godot developers.</p>
            <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem; flex-wrap: wrap;">
                <span style="background: rgba(0, 217, 255, 0.1); color: var(--accent); padding: 0.5rem 1rem; border-radius: 20px; border: 1px solid rgba(0, 217, 255, 0.3);">Gemini API</span>
                <span style="background: rgba(255, 107, 53, 0.1); color: var(--primary); padding: 0.5rem 1rem; border-radius: 20px; border: 1px solid rgba(255, 107, 53, 0.3);">Groq API</span>
                <span style="background: rgba(40, 167, 69, 0.1); color: var(--success); padding: 0.5rem 1rem; border-radius: 20px; border: 1px solid rgba(40, 167, 69, 0.3);">Multi-Provider</span>
            </div>
        </div>
    </section>

    <!-- API Configuration -->
    <div class="container">
        <div class="api-config">
            <h3>üîß API Configuration</h3>
            <p style="color: #aaa; margin-bottom: 1rem;">Configure your API keys for AI features. Default keys are pre-filled for testing.</p>
            
            <div class="api-input-group">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: #ccc;">Gemini API Key</label>
                    <input type="text" id="geminiApiKey" class="api-input" value="AIzaSyDIBSAvRRWhF7DW6jc0qoNa1nZgjPXvGoY">
                    <small style="color: #888; font-size: 0.8rem;">For code analysis and generation</small>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: #ccc;">Groq API Key</label>
                    <input type="text" id="groqApiKey" class="api-input" value="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">
                    <small style="color: #888; font-size: 0.8rem;">For fast chat responses</small>
                </div>
            </div>
            
            <div class="button-group" style="margin-top: 1.5rem;">
                <button class="btn btn-primary" onclick="saveApiKeys()">
                    üíæ Save API Keys
                </button>
                <button class="btn btn-secondary" onclick="testApiConnection()">
                    üîå Test Connection
                </button>
                <button class="btn btn-secondary" onclick="resetApiKeys()">
                    üîÑ Reset to Default
                </button>
            </div>
            
            <div class="api-status" id="apiStatus">
                <span class="status-dot"></span>
                <span class="status-text">Checking API status...</span>
            </div>
        </div>
    </div>

    <!-- AI Assistant Container -->
    <div class="container">
        <div class="ai-assistant-container">
            <!-- Tabs -->
            <div class="ai-tabs">
                <button class="ai-tab active" data-tab="analysis">üîç Code Analysis</button>
                <button class="ai-tab" data-tab="generation">ü§ñ Code Generation</button>
                <button class="ai-tab" data-tab="autocomplete">üí° Auto Complete</button>
                <button class="ai-tab" data-tab="nodebuilder">üé¨ Node Builder</button>
                <button class="ai-tab" data-tab="chat">üí¨ AI Chat</button>
            </div>

            <!-- Code Analysis Tab -->
            <div class="ai-tab-content active" id="analysis">
                <div class="split-container">
                    <div class="panel">
                        <div class="panel-header">
                            <h3>Input Code</h3>
                            <p style="color: #aaa; font-size: 0.9rem; margin-top: 0.5rem;">Paste your GDScript code for analysis</p>
                        </div>
                        <textarea id="codeInput" placeholder="Paste your GDScript code here...">extends CharacterBody2D

var speed = 300
var player_speed

func _ready():
    pass

func _physics_process(delta):
    var input_dir = Input.get_vector("ui_left", "ui_right", "ui_up", "ui_down")
    velocity = input_dir * speed
    position += velocity * delta</textarea>
                        <div class="button-group">
                            <button class="btn btn-primary" onclick="analyzeCode()">
                                <span id="analyzeIcon">üîç</span> Analyze Code
                            </button>
                            <button class="btn btn-secondary" onclick="pasteFromClipboard('codeInput')">
                                üìã Paste from Clipboard
                            </button>
                            <button class="btn btn-secondary" onclick="clearCode('codeInput')">
                                üóëÔ∏è Clear
                            </button>
                            <button class="btn btn-secondary" onclick="loadSampleCode()">
                                üìù Load Sample
                            </button>
                        </div>
                    </div>

                    <div class="panel">
                        <div class="panel-header">
                            <h3>Analysis Results</h3>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <p style="color: #aaa; font-size: 0.9rem;">Found <span id="issueCount">0</span> issue(s)</p>
                                <div class="button-group">
                                    <button class="btn btn-success" id="applyFixesBtn" disabled onclick="applyFixes()">
                                        üîß Apply Fixes
                                    </button>
                                    <button class="btn btn-accent" id="copyFixedBtn" disabled onclick="copyFixedCode()">
                                        üìã Copy Fixed
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="results" id="analysisResults">
                            <p style="color: #666; text-align: center; padding: 2rem;">
                                Click "Analyze Code" to find bugs, warnings, and suggestions for improvement.
                            </p>
                        </div>
                        <div id="analysisError" class="error-message" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <!-- Code Generation Tab -->
            <div class="ai-tab-content" id="generation">
                <div class="split-container">
                    <div class="panel">
                        <div class="panel-header">
                            <h3>Code Description</h3>
                            <p style="color: #aaa; font-size: 0.9rem; margin-top: 0.5rem;">Describe the code you want to generate</p>
                        </div>
                        <textarea id="descriptionInput" placeholder="Describe the GDScript code you want to generate...">Create a player controller with CharacterBody2D, movement, jumping, and dash ability</textarea>
                        
                        <div class="options-container">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: #aaa;">Code Style</label>
                                <select id="styleOption">
                                    <option value="clean">Clean & Efficient</option>
                                    <option value="with_comments">With Comments</option>
                                    <option value="beginner">Beginner Friendly</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: #aaa;">Complexity</label>
                                <select id="complexityOption">
                                    <option value="simple">Simple</option>
                                    <option value="moderate" selected>Moderate</option>
                                    <option value="advanced">Advanced</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="button-group">
                            <button class="btn btn-primary" onclick="generateCode()">
                                <span id="generateIcon">ü§ñ</span> Generate Code
                            </button>
                            <button class="btn btn-accent" onclick="addComments()">
                                üí¨ Add Comments
                            </button>
                            <button class="btn btn-secondary" onclick="clearCode('generatedCode')">
                                üóëÔ∏è Clear
                            </button>
                        </div>
                        <div id="generationError" class="error-message" style="display: none;"></div>
                    </div>

                    <div class="panel">
                        <div class="panel-header">
                            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                <h3>Generated Code</h3>
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <span id="lineCount" style="color: #aaa; font-size: 0.9rem;">0 lines</span>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #aaa;">
                                        <input type="checkbox" id="editModeCheck" onchange="toggleEditMode()"> Edit Mode
                                    </label>
                                </div>
                            </div>
                        </div>
                        <pre id="generatedCode" contenteditable="false">// Generated code will appear here...</pre>
                        <div class="button-group">
                            <button class="btn btn-accent" onclick="copyToClipboard('generatedCode')">
                                üìã Copy Code
                            </button>
                            <button class="btn btn-secondary" onclick="validateCode()">
                                ‚úì Validate
                            </button>
                            <button class="btn btn-secondary" onclick="refineCode()">
                                ‚ú® Refine
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Chat Tab -->
            <div class="ai-tab-content" id="chat">
                <div class="panel" style="height: 600px;">
                    <div class="panel-header">
                        <h3>ü§ñ Godot AI Assistant</h3>
                        <p style="color: #aaa; font-size: 0.9rem; margin-top: 0.5rem;">Ask me anything about Godot, GDScript, or game development!</p>
                    </div>
                    
                    <div class="chat-container">
                        <div class="chat-history" id="chatHistory">
                            <div class="chat-message ai">
                                <strong>AI Assistant:</strong><br>
                                Hello! I'm your Godot AI assistant. Ask me anything about Godot, GDScript, game development, or your project!
                            </div>
                        </div>
                        
                        <div class="chat-input-container">
                            <input type="text" class="chat-input" id="chatInput" placeholder="Type your question about Godot..." onkeypress="handleChatKeyPress(event)">
                            <button class="btn btn-primary" onclick="sendChatMessage()">
                                <span id="sendIcon">‚úâÔ∏è</span> Send
                            </button>
                        </div>
                    </div>
                    
                    <div class="button-group" style="margin-top: 1rem;">
                        <button class="btn btn-secondary" onclick="clearChat()">
                            üóëÔ∏è Clear Chat
                        </button>
                        <button class="btn btn-secondary" onclick="suggestChatTopic('How do I optimize GDScript performance?')">
                            ‚ö° Performance
                        </button>
                        <button class="btn btn-secondary" onclick="suggestChatTopic('How to implement multiplayer in Godot 4?')">
                            üåê Multiplayer
                        </button>
                        <button class="btn btn-secondary" onclick="suggestChatTopic('Best practices for mobile Godot games?')">
                            üì± Mobile
                        </button>
                    </div>
                    <div id="chatError" class="error-message" style="display: none;"></div>
                </div>
            </div>

            <!-- Status Bar -->
            <div class="status-bar">
                <div id="statusLabel">AI Assistant Ready - Configure API keys above</div>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <span id="aiStatus" style="color: #aaa;">‚óè Checking API...</span>
                    <button class="btn btn-secondary" style="padding: 0.3rem 0.8rem; font-size: 0.8rem;" onclick="resetAssistant()">
                        üîÑ Reset
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="logo" style="margin-bottom: 1rem;">GODOT ASSETS</div>
            <p>Ready-made Godot Scripts & Systems for Faster Game Development</p>
            <div style="margin-top: 2rem; font-size: 0.9rem; color: #ccc;">
                AI Coding Assistant - Powered by Gemini & Groq APIs<br>
                ¬© 2024 Godot Game Assets Marketplace. All rights reserved.
            </div>
        </div>
    </footer>

    <script>
        // API Configuration
        let geminiApiKey = "AIzaSyDIBSAvRRWhF7DW6jc0qoNa1nZgjPXvGoY";
        let groqApiKey = "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";
        let apiStatus = "checking";

        // State
        let currentBugs = [];
        let chatMessages = [
            { role: "ai", content: "Hello! I'm your Godot AI assistant. Ask me anything about Godot, GDScript, game development, or your project!" }
        ];

        // Initialize API keys from local storage
        function loadApiKeys() {
            const savedGemini = localStorage.getItem('geminiApiKey');
            const savedGroq = localStorage.getItem('groqApiKey');
            
            if (savedGemini) {
                document.getElementById('geminiApiKey').value = savedGemini;
                geminiApiKey = savedGemini;
            }
            
            if (savedGroq) {
                document.getElementById('groqApiKey').value = savedGroq;
                groqApiKey = savedGroq;
            }
            
            updateApiStatus();
        }

        function saveApiKeys() {
            geminiApiKey = document.getElementById('geminiApiKey').value.trim();
            groqApiKey = document.getElementById('groqApiKey').value.trim();
            
            localStorage.setItem('geminiApiKey', geminiApiKey);
            localStorage.setItem('groqApiKey', groqApiKey);
            
            updateStatus('‚úÖ API keys saved locally');
            updateApiStatus();
        }

        function resetApiKeys() {
            geminiApiKey = "AIzaSyDIBSAvRRWhF7DW6jc0qoNa1nZgjPXvGoY";
            groqApiKey = "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";
            
            document.getElementById('geminiApiKey').value = geminiApiKey;
            document.getElementById('groqApiKey').value = groqApiKey;
            
            localStorage.setItem('geminiApiKey', geminiApiKey);
            localStorage.setItem('groqApiKey', groqApiKey);
            
            updateStatus('‚úÖ API keys reset to default');
            updateApiStatus();
        }

        async function testApiConnection() {
            updateStatus('üîå Testing API connections...');
            
            const statusElement = document.getElementById('apiStatus');
            statusElement.className = 'api-status checking';
            statusElement.innerHTML = '<span class="loading"></span> Testing Gemini API...';
            
            try {
                // Test Gemini API
                const geminiTest = await callGeminiAPI("Test connection", 0.1);
                if (geminiTest) {
                    statusElement.innerHTML = '<span class="status-dot" style="color: var(--success);">‚óè</span> Gemini: Connected ‚úì';
                    apiStatus = "connected";
                } else {
                    statusElement.innerHTML = '<span class="status-dot" style="color: var(--error);">‚óè</span> Gemini: Failed ‚úó';
                    apiStatus = "partial";
                }
                
                updateStatus('‚úÖ API test completed');
                updateApiStatus();
            } catch (error) {
                statusElement.innerHTML = `<span class="status-dot" style="color: var(--error);">‚óè</span> Connection failed: ${error.message}`;
                apiStatus = "failed";
                updateStatus('‚ùå API test failed');
                updateApiStatus();
            }
        }

        function updateApiStatus() {
            const hasGemini = geminiApiKey && geminiApiKey.length > 10;
            const hasGroq = groqApiKey && groqApiKey.length > 10;
            
            let statusText = "";
            let statusColor = "#aaa";
            
            if (hasGemini && hasGroq) {
                statusText = "Both APIs configured";
                statusColor = "var(--success)";
            } else if (hasGemini || hasGroq) {
                statusText = "One API configured";
                statusColor = "var(--primary)";
            } else {
                statusText = "No API keys configured";
                statusColor = "var(--error)";
            }
            
            document.getElementById('aiStatus').textContent = `‚óè ${statusText}`;
            document.getElementById('aiStatus').style.color = statusColor;
        }

        // Tab Management
        document.querySelectorAll('.ai-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.dataset.tab;
                
                // Update active tab
                document.querySelectorAll('.ai-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Update active content
                document.querySelectorAll('.ai-tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabId).classList.add('active');
                
                updateStatus(`Switched to ${tab.textContent.trim()}`);
            });
        });

        // API Call Functions
        async function callGeminiAPI(prompt, temperature = 0.3) {
            if (!geminiApiKey) {
                throw new Error("Gemini API key not configured");
            }

            const apiUrl = "https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent";
            
            const response = await fetch(`${apiUrl}?key=${geminiApiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        temperature: temperature,
                        maxOutputTokens: 8000,
                        topP: 0.95,
                        topK: 40
                    }
                })
            });

            if (!response.ok) {
                throw new Error(`API request failed: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error.message);
            }

            if (!data.candidates || data.candidates.length === 0) {
                throw new Error("No response from API");
            }

            return data.candidates[0].content.parts[0].text;
        }

        async function callGroqAPI(prompt, temperature = 0.7) {
            if (!groqApiKey) {
                throw new Error("Groq API key not configured");
            }

            const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${groqApiKey}`
                },
                body: JSON.stringify({
                    model: "llama-3.3-70b-versatile",
                    messages: [
                        {
                            role: "system",
                            content: "You are an expert Godot 4 GDScript developer. Provide helpful, accurate responses."
                        },
                        {
                            role: "user",
                            content: prompt
                        }
                    ],
                    temperature: temperature,
                    max_tokens: 8000,
                    top_p: 0.95
                })
            });

            if (!response.ok) {
                throw new Error(`API request failed: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error.message);
            }

            if (!data.choices || data.choices.length === 0) {
                throw new Error("No response from API");
            }

            return data.choices[0].message.content;
        }

        // Code Analysis Functions
        async function analyzeCode() {
            const code = document.getElementById('codeInput').value;
            if (!code.trim()) {
                updateStatus('‚ö†Ô∏è Please paste some GDScript code to analyze');
                return;
            }

            updateStatus('üîç Analyzing code...');
            document.getElementById('analysisError').style.display = 'none';
            
            const analyzeBtn = document.querySelector('[onclick="analyzeCode()"]');
            const originalText = analyzeBtn.innerHTML;
            analyzeBtn.innerHTML = '<span class="loading"></span> Analyzing...';
            analyzeBtn.disabled = true;

            try {
                const prompt = createAnalysisPrompt(code);
                const result = await callGeminiAPI(prompt, 0.3);
                
                const bugs = parseAnalysisResult(result, code);
                currentBugs = bugs;
                
                displayAnalysisResults(bugs);
                
                if (bugs.length > 0) {
                    document.getElementById('applyFixesBtn').disabled = false;
                    document.getElementById('copyFixedBtn').disabled = false;
                    updateStatus(`‚úÖ Analysis complete - ${bugs.length} issue(s) found`);
                } else {
                    updateStatus('‚úÖ Analysis complete - No issues found');
                }
            } catch (error) {
                showError('analysisError', `Analysis failed: ${error.message}`);
                updateStatus('‚ùå Analysis failed');
                currentBugs = [];
            } finally {
                analyzeBtn.innerHTML = originalText;
                analyzeBtn.disabled = false;
            }
        }

        function createAnalysisPrompt(code) {
            return `Analyze this Godot GDScript code for bugs, issues, and improvements. Return ONLY a JSON array with the following structure for each issue found:

[
    {
        "line": 4,
        "type": "warning",
        "message": "Unused variable 'player_speed'",
        "fix": "Remove the variable or use it in your code"
    }
]

Valid types: "error", "warning", "suggestion"

Code to analyze:
\`\`\`gdscript
${code}
\`\`\`

IMPORTANT: 
- Return ONLY the JSON array, no additional text or explanations.
- Provide specific line numbers for each issue.
- Suggest practical fixes that can be applied automatically.
- Focus on Godot 4 best practices and common pitfalls.

Return ONLY the JSON array:`;
        }

        function parseAnalysisResult(result, originalCode) {
            const bugs = [];
            
            // Clean the result
            result = cleanAPIResponse(result);
            
            // Try to parse JSON
            try {
                const jsonStart = result.indexOf('[');
                const jsonEnd = result.lastIndexOf(']');
                
                if (jsonStart !== -1 && jsonEnd !== -1) {
                    const jsonStr = result.substring(jsonStart, jsonEnd + 1);
                    const data = JSON.parse(jsonStr);
                    
                    if (Array.isArray(data)) {
                        const lineCount = originalCode.split('\n').length;
                        
                        data.forEach(bugData => {
                            if (bugData.line && bugData.type && bugData.message && bugData.fix) {
                                const lineNum = parseInt(bugData.line);
                                if (lineNum > 0 && lineNum <= lineCount) {
                                    bugs.push({
                                        line: lineNum,
                                        type: bugData.type,
                                        message: bugData.message,
                                        fix: bugData.fix
                                    });
                                }
                            }
                        });
                    }
                }
            } catch (e) {
                console.warn('Failed to parse JSON response:', e);
            }
            
            return bugs;
        }

        function cleanAPIResponse(result) {
            return result.replace(/```json/g, '')
                        .replace(/```/g, '')
                        .trim();
        }

        function displayAnalysisResults(bugs) {
            const resultsDiv = document.getElementById('analysisResults');
            const issueCount = document.getElementById('issueCount');
            
            issueCount.textContent = bugs.length;
            
            if (bugs.length === 0) {
                resultsDiv.innerHTML = '<div class="success-message">‚úÖ No issues found! Your code looks good.</div>';
                return;
            }

            let html = `<h4>Found ${bugs.length} issue(s):</h4><br>`;
            
            bugs.forEach((bug, index) => {
                let color, icon;
                switch(bug.type) {
                    case "error": color = "var(--error)"; icon = "‚ùå"; break;
                    case "warning": color = "var(--primary)"; icon = "‚ö†Ô∏è"; break;
                    case "suggestion": color = "var(--accent)"; icon = "üí°"; break;
                    default: color = "white"; icon = "‚Ä¢";
                }
                
                html += `
                    <div style="margin-bottom: 1.5rem; border-left: 3px solid ${color}; padding-left: 1rem;">
                        <div style="color: ${color}; font-weight: bold; margin-bottom: 0.5rem;">
                            ${icon} Line ${bug.line}: ${bug.message}
                        </div>
                        <div style="color: #aaa; font-style: italic;">
                            Fix: ${bug.fix}
                        </div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }

        function applyFixes() {
            if (currentBugs.length === 0) {
                updateStatus('‚ö†Ô∏è No fixes to apply');
                return;
            }

            updateStatus('üîß Applying fixes...');
            
            // Simple fix application
            const originalCode = document.getElementById('codeInput').value;
            let fixedCode = originalCode;
            
            // Apply fixes based on bug type
            currentBugs.forEach(bug => {
                const lines = fixedCode.split('\n');
                if (bug.line <= lines.length) {
                    const lineIndex = bug.line - 1;
                    
                    if (bug.fix.includes('move_and_slide')) {
                        lines[lineIndex] = '    move_and_slide()';
                    } else if (bug.message.includes('Unused variable')) {
                        lines[lineIndex] = '';
                    } else if (bug.message.includes('Empty _ready()')) {
                        lines[lineIndex] = '';
                    }
                }
                
                fixedCode = lines.filter(line => line.trim() !== '').join('\n');
            });
            
            document.getElementById('codeInput').value = fixedCode;
            
            document.getElementById('analysisResults').innerHTML = 
                '<div class="success-message">‚úÖ All fixes applied! You can analyze the code again to check for remaining issues.</div>';
            
            document.getElementById('issueCount').textContent = '0';
            document.getElementById('applyFixesBtn').disabled = true;
            document.getElementById('copyFixedBtn').disabled = true;
            currentBugs = [];
            
            updateStatus('‚úÖ Fixes applied successfully');
        }

        // Code Generation Functions
        async function generateCode() {
            const description = document.getElementById('descriptionInput').value.trim();
            if (!description) {
                updateStatus('‚ö†Ô∏è Please enter a description');
                return;
            }

            updateStatus('ü§ñ Generating code...');
            document.getElementById('generationError').style.display = 'none';
            
            document.getElementById('generatedCode').textContent = '// Generating code, please wait...';
            updateLineCount();
            
            const generateBtn = document.querySelector('[onclick="generateCode()"]');
            const originalText = generateBtn.innerHTML;
            generateBtn.innerHTML = '<span class="loading"></span> Generating...';
            generateBtn.disabled = true;

            try {
                const style = document.getElementById('styleOption').value;
                const complexity = document.getElementById('complexityOption').value;
                
                const prompt = createGenerationPrompt(description, style, complexity);
                const result = await callGeminiAPI(prompt, 0.3);
                
                const cleanedCode = cleanGeneratedCode(result);
                document.getElementById('generatedCode').textContent = cleanedCode;
                updateLineCount();
                applySyntaxHighlighting('generatedCode');
                
                updateStatus('‚úÖ Code generated successfully!');
            } catch (error) {
                showError('generationError', `Generation failed: ${error.message}`);
                updateStatus('‚ùå Code generation failed');
            } finally {
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
            }
        }

        function createGenerationPrompt(description, style, complexity) {
            let prompt = `You are an expert Godot 4 GDScript developer. Generate ONLY executable GDScript code for the following request.

REQUEST: ${description}

REQUIREMENTS:
- Use Godot 4 syntax and best practices
- Include proper type hints (var name: Type)
- Use @export for configurable variables
- Use modern Godot 4 APIs (CharacterBody2D, move_and_slide(), etc.)
- Make code production-ready and efficient
- Do NOT include any explanations, markdown, or text outside the code
- Return ONLY pure GDScript code that can run immediately
`;

            // Add style preferences
            switch(style) {
                case "with_comments":
                    prompt += "- Add detailed inline comments explaining the code\n";
                    break;
                case "beginner":
                    prompt += "- Add extensive comments for beginners\n- Use clear, descriptive variable names\n- Add explanatory comments for each section\n";
                    break;
                default:
                    prompt += "- Keep comments minimal and only where necessary\n";
            }

            // Add complexity level
            switch(complexity) {
                case "simple":
                    prompt += "- Keep the implementation simple and straightforward\n- Avoid advanced features\n";
                    break;
                case "advanced":
                    prompt += "- Include advanced features and optimizations\n- Use sophisticated patterns where appropriate\n";
                    break;
                default:
                    prompt += "- Use moderate complexity with balanced features\n";
            }

            prompt += "\nIMPORTANT: Return ONLY the GDScript code. No markdown formatting, no explanations, no ```gdscript``` tags. Just pure code.";
            
            return prompt;
        }

        function cleanGeneratedCode(code) {
            // Remove markdown code blocks
            code = code.replace(/```gdscript/g, '')
                      .replace(/```gd/g, '')
                      .replace(/```/g, '')
                      .trim();
            
            // Remove common AI prefixes
            const lines = code.split('\n');
            const cleanedLines = [];
            let codeStarted = false;
            
            for (const line of lines) {
                const trimmed = line.trim();
                
                if (!codeStarted && trimmed === '') continue;
                
                if (!codeStarted) {
                    if (trimmed.startsWith('Here') || trimmed.startsWith('This') || trimmed.startsWith('The code')) {
                        continue;
                    }
                    if (trimmed.startsWith('extends') || trimmed.startsWith('@tool') || trimmed.startsWith('class_name')) {
                        codeStarted = true;
                    }
                }
                
                if (codeStarted) {
                    cleanedLines.push(line);
                }
            }
            
            return cleanedLines.join('\n').trim();
        }

        async function addComments() {
            const code = document.getElementById('generatedCode').textContent;
            if (!code.trim() || code.includes('# Error')) {
                updateStatus('‚ö†Ô∏è No code to add comments to');
                return;
            }

            updateStatus('üí¨ Adding comments...');
            
            try {
                const prompt = `Add detailed comments to this GDScript code explaining what each section does:

\`\`\`gdscript
${code}
\`\`\`

IMPORTANT: Return ONLY the commented code, no explanations.`;
                
                const result = await callGeminiAPI(prompt, 0.3);
                const commentedCode = cleanGeneratedCode(result);
                document.getElementById('generatedCode').textContent = commentedCode;
                updateLineCount();
                applySyntaxHighlighting('generatedCode');
                
                updateStatus('‚úÖ Comments added!');
            } catch (error) {
                updateStatus('‚ùå Failed to add comments');
            }
        }

        // Chat Functions
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            chatMessages.push({ role: "user", content: message });
            updateChatDisplay();
            input.value = "";
            
            updateStatus('üí¨ Getting AI response...');
            document.getElementById('chatError').style.display = 'none';
            
            const sendBtn = document.querySelector('[onclick="sendChatMessage()"]');
            const originalText = sendBtn.innerHTML;
            sendBtn.innerHTML = '<span class="loading"></span> Thinking...';
            sendBtn.disabled = true;

            try {
                const prompt = createChatPrompt(message);
                const response = await callGroqAPI(prompt, 0.7);
                
                const cleanedResponse = cleanChatResponse(response);
                chatMessages.push({ role: "ai", content: cleanedResponse });
                updateChatDisplay();
                updateStatus('üí¨ Response received');
            } catch (error) {
                showError('chatError', `Chat failed: ${error.message}`);
                
                // Fallback to Gemini
                try {
                    const prompt = `You are an expert Godot game development assistant. Answer this question about Godot: ${message}`;
                    const response = await callGeminiAPI(prompt, 0.7);
                    
                    const cleanedResponse = cleanChatResponse(response);
                    chatMessages.push({ role: "ai", content: cleanedResponse });
                    updateChatDisplay();
                    updateStatus('üí¨ Response received (using Gemini)');
                } catch (fallbackError) {
                    chatMessages.push({ 
                        role: "ai", 
                        content: "I apologize, but I'm having trouble responding right now. Please check your API connection and try again." 
                    });
                    updateChatDisplay();
                    updateStatus('‚ùå Both APIs failed');
                }
            } finally {
                sendBtn.innerHTML = originalText;
                sendBtn.disabled = false;
                scrollChatToBottom();
            }
        }

        function createChatPrompt(message) {
            const recentMessages = chatMessages.slice(-4);
            const context = recentMessages.map(msg => 
                `${msg.role === 'user' ? 'User' : 'Assistant'}: ${msg.content}`
            ).join('\n');

            return `You are an expert Godot game development assistant. Provide helpful, accurate responses about Godot, GDScript, game development, and related programming topics.

CONVERSATION CONTEXT:
${context}

USER'S NEW QUESTION: ${message}

RESPONSE GUIDELINES:
- Be concise but helpful
- Provide code examples when relevant
- Explain Godot-specific concepts clearly
- Suggest best practices
- If asking for code, provide complete, runnable GDScript examples
- If the question is unclear, ask for clarification
- Focus on Godot 4.x features and syntax

Please provide a helpful response:`;
        }

        function cleanChatResponse(response) {
            // Remove markdown code blocks but keep content
            response = response.replace(/```gdscript/g, '')
                              .replace(/```gd/g, '')
                              .replace(/```/g, '')
                              .trim();
            
            // Remove common AI prefixes
            const lines = response.split('\n');
            const cleanedLines = [];
            let contentStarted = false;
            
            for (const line of lines) {
                const trimmed = line.trim();
                
                if (!contentStarted) {
                    if (trimmed.startsWith('Sure!') || trimmed.startsWith('Of course!') || trimmed.startsWith('Here')) {
                        contentStarted = true;
                        cleanedLines.push(trimmed);
                    } else if (trimmed && !trimmed.startsWith('As an AI')) {
                        contentStarted = true;
                        cleanedLines.push(line);
                    }
                } else {
                    cleanedLines.push(line);
                }
            }
            
            return cleanedLines.join('\n').trim() || response;
        }

        // Utility Functions
        function updateStatus(message) {
            document.getElementById('statusLabel').textContent = message;
        }

        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
        }

        function pasteFromClipboard(elementId) {
            navigator.clipboard.readText().then(text => {
                if (text.trim()) {
                    document.getElementById(elementId).value = text;
                    updateStatus('üìã Text pasted from clipboard');
                } else {
                    updateStatus('‚ö†Ô∏è Clipboard is empty');
                }
            }).catch(() => {
                updateStatus('‚ö†Ô∏è Cannot access clipboard');
            });
        }

        function clearCode(elementId) {
            if (elementId.includes('Input')) {
                document.getElementById(elementId).value = '';
            } else {
                document.getElementById(elementId).textContent = '';
            }
            
            if (elementId === 'codeInput') {
                document.getElementById('analysisResults').innerHTML = 
                    '<p style="color: #666; text-align: center; padding: 2rem;">Click "Analyze Code" to find bugs, warnings, and suggestions for improvement.</p>';
                document.getElementById('issueCount').textContent = '0';
                document.getElementById('applyFixesBtn').disabled = true;
                document.getElementById('copyFixedBtn').disabled = true;
                currentBugs = [];
            }
            
            if (elementId === 'generatedCode') {
                updateLineCount();
            }
            
            updateStatus('üóëÔ∏è Cleared');
        }

        function loadSampleCode() {
            document.getElementById('codeInput').value = `extends CharacterBody2D

var speed = 300
var player_speed

func _ready():
    pass

func _physics_process(delta):
    var input_dir = Input.get_vector("ui_left", "ui_right", "ui_up", "ui_down")
    velocity = input_dir * speed
    position += velocity * delta`;
            
            updateStatus('üìù Sample code loaded');
        }

        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent || element.value;
            
            if (!text.trim()) {
                updateStatus('‚ö†Ô∏è No code to copy');
                return;
            }
            
            navigator.clipboard.writeText(text).then(() => {
                updateStatus('‚úÖ Code copied to clipboard!');
            });
        }

        function copyFixedCode() {
            if (currentBugs.length === 0) {
                updateStatus('‚ö†Ô∏è No fixes to copy');
                return;
            }

            const originalCode = document.getElementById('codeInput').value;
            let fixedCode = originalCode;
            
            // Apply same fixes as in applyFixes
            currentBugs.forEach(bug => {
                if (bug.fix.includes('move_and_slide')) {
                    fixedCode = fixedCode.replace('position += velocity * delta', 'move_and_slide()');
                }
            });
            
            navigator.clipboard.writeText(fixedCode).then(() => {
                updateStatus('‚úÖ Fixed code copied to clipboard!');
            });
        }

        function toggleEditMode() {
            const codeElement = document.getElementById('generatedCode');
            const isEditable = document.getElementById('editModeCheck').checked;
            codeElement.contentEditable = isEditable;
            
            if (isEditable) {
                codeElement.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';
                codeElement.style.border = '1px solid var(--primary)';
                updateStatus('Edit mode: ON ‚úèÔ∏è');
            } else {
                codeElement.style.backgroundColor = 'var(--code-bg)';
                codeElement.style.border = '1px solid rgba(255, 255, 255, 0.1)';
                updateStatus('Edit mode: OFF üîí');
            }
        }

        function updateLineCount() {
            const code = document.getElementById('generatedCode').textContent;
            const lines = code.split('\n').length;
            const chars = code.length;
            document.getElementById('lineCount').textContent = `${lines} lines, ${chars} chars`;
        }

        function validateCode() {
            const code = document.getElementById('generatedCode').textContent;
            if (!code.trim()) {
                updateStatus('‚ö†Ô∏è No code to validate');
                return;
            }

            const issues = [];
            if (!code.includes('extends')) {
                issues.push('Missing extends declaration');
            }
            if (!code.includes('func')) {
                issues.push('No functions defined');
            }

            if (issues.length === 0) {
                updateStatus('‚úÖ Code looks valid!');
            } else {
                updateStatus(`‚ö†Ô∏è Issues: ${issues.join(', ')}`);
            }
        }

        async function refineCode() {
            const code = document.getElementById('generatedCode').textContent;
            if (!code.trim() || code.includes('# Error')) {
                updateStatus('‚ö†Ô∏è No code to refine');
                return;
            }

            updateStatus('‚ú® Refining code...');
            
            try {
                const prompt = `Improve and optimize this GDScript code, make it more efficient and add better error handling:

\`\`\`gdscript
${code}
\`\`\`

IMPORTANT: Return ONLY the improved code, no explanations.`;
                
                const result = await callGeminiAPI(prompt, 0.3);
                const refinedCode = cleanGeneratedCode(result);
                document.getElementById('generatedCode').textContent = refinedCode;
                updateLineCount();
                applySyntaxHighlighting('generatedCode');
                
                updateStatus('‚úÖ Code refined!');
            } catch (error) {
                updateStatus('‚ùå Refinement failed');
            }
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
                event.preventDefault();
            }
        }

        function updateChatDisplay() {
            const chatHistory = document.getElementById('chatHistory');
            let html = '';
            
            chatMessages.forEach(msg => {
                const isUser = msg.role === "user";
                html += `
                    <div class="chat-message ${isUser ? 'user' : 'ai'}">
                        <strong>${isUser ? 'You' : 'AI Assistant'}:</strong><br>
                        ${msg.content}
                    </div>
                `;
            });
            
            chatHistory.innerHTML = html;
            scrollChatToBottom();
        }

        function scrollChatToBottom() {
            const chatHistory = document.getElementById('chatHistory');
            setTimeout(() => {
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }, 100);
        }

        function clearChat() {
            chatMessages = [
                { role: "ai", content: "Hello! I'm your Godot AI assistant. Ask me anything about Godot, GDScript, game development, or your project!" }
            ];
            updateChatDisplay();
            updateStatus('üí¨ Chat cleared');
        }

        function suggestChatTopic(topic) {
            document.getElementById('chatInput').value = topic;
            document.getElementById('chatInput').focus();
        }

        function applySyntaxHighlighting(elementId) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            let code = element.textContent;
            
            // Keyword highlighting
            const keywords = ['extends', 'class_name', 'var', 'const', 'func', 'if', 'else', 'elif', 'for', 'while', 'match', 'return', 'pass', 'break', 'continue', 'await', 'signal', 'enum', 'static', 'tool'];
            keywords.forEach(keyword => {
                const regex = new RegExp(`\\b${keyword}\\b`, 'g');
                code = code.replace(regex, `<span class="code-keyword">${keyword}</span>`);
            });
            
            // String highlighting
            code = code.replace(/"([^"]*)"/g, '<span class="code-string">"$1"</span>');
            code = code.replace(/'([^']*)'/g, "<span class=\"code-string\">'$1'</span>");
            
            // Comment highlighting
            code = code.replace(/#(.*)/g, '<span class="code-comment">#$1</span>');
            
            // Function highlighting
            code = code.replace(/\b(func\s+)(\w+)/g, '$1<span class="code-function">$2</span>');
            
            // Number highlighting
            code = code.replace(/\b(\d+\.?\d*)\b/g, '<span class="code-number">$1</span>');
            
            element.innerHTML = code;
        }

        function resetAssistant() {
            // Reset all tabs
            clearCode('codeInput');
            clearCode('descriptionInput');
            clearCode('generatedCode');
            
            // Reset UI elements
            document.getElementById('editModeCheck').checked = false;
            toggleEditMode();
            document.getElementById('applyFixesBtn').disabled = true;
            document.getElementById('copyFixedBtn').disabled = true;
            
            // Clear errors
            document.querySelectorAll('.error-message').forEach(el => {
                el.style.display = 'none';
            });
            
            // Switch to first tab
            document.querySelectorAll('.ai-tab').forEach((tab, index) => {
                tab.classList.remove('active');
                if (index === 0) tab.classList.add('active');
            });
            
            document.querySelectorAll('.ai-tab-content').forEach((content, index) => {
                content.classList.remove('active');
                if (index === 0) content.classList.add('active');
            });
            
            updateStatus('AI Assistant Reset - Ready to use!');
            updateApiStatus();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Load API keys
            loadApiKeys();
            
            // Update API status
            updateApiStatus();
            
            // Apply syntax highlighting
            applySyntaxHighlighting('generatedCode');
            
            // Update line counts
            updateLineCount();
            
            // Set up real-time line count updates
            document.getElementById('generatedCode').addEventListener('input', () => {
                updateLineCount();
                applySyntaxHighlighting('generatedCode');
            });
            
            // Test API connection on load
            setTimeout(testApiConnection, 1000);
            
            // Focus on first input
            document.getElementById('codeInput').focus();
        });
    </script>
</body>
</html>
