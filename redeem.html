<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Store</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            padding: 20px; 
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { 
            text-align: center; 
            color: white; 
            margin-bottom: 40px; 
            font-size: 2.5em; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3); 
        }
        .loading { 
            text-align: center; 
            color: white; 
            font-size: 1.3em; 
            padding: 40px; 
        }
        .error { 
            background: #e74c3c; 
            color: white; 
            padding: 20px; 
            border-radius: 10px; 
            margin: 20px 0; 
            text-align: center; 
        }
        .products { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 30px; 
            margin-bottom: 40px; 
        }
        .product { 
            background: white; 
            border-radius: 15px; 
            padding: 25px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            transition: transform 0.3s ease; 
        }
        .product:hover { transform: translateY(-5px); }
        .product h2 { 
            color: #333; 
            margin-bottom: 10px; 
            font-size: 1.5em; 
        }
        .product-id { 
            color: #999; 
            font-size: 0.85em; 
            margin-bottom: 15px; 
        }
        .product-image { 
            width: 100%; 
            height: 200px; 
            object-fit: contain; 
            margin-bottom: 15px; 
            background: #f5f5f5; 
            border-radius: 10px; 
        }
        .product .price { 
            font-size: 1.8em; 
            color: #667eea; 
            font-weight: bold; 
            margin-bottom: 20px; 
        }
        .buy-btn { 
            width: 100%; 
            padding: 15px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            font-size: 1.1em; 
            cursor: pointer; 
            transition: opacity 0.3s ease; 
        }
        .buy-btn:hover { opacity: 0.9; }
        .buy-btn:disabled { 
            background: #ccc; 
            cursor: not-allowed; 
        }
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.7); 
            z-index: 1000; 
            align-items: center; 
            justify-content: center; 
        }
        .modal.active { display: flex; }
        .modal-content { 
            background: white; 
            padding: 40px; 
            border-radius: 15px; 
            max-width: 500px; 
            width: 90%; 
        }
        .modal h2 { color: #333; margin-bottom: 20px; }
        .modal input { 
            width: 100%; 
            padding: 15px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            font-size: 1em; 
            margin-bottom: 20px; 
        }
        .modal input:focus { outline: none; border-color: #667eea; }
        .modal-buttons { display: flex; gap: 10px; }
        .modal-buttons button { 
            flex: 1; 
            padding: 15px; 
            border: none; 
            border-radius: 8px; 
            font-size: 1em; 
            cursor: pointer; 
        }
        .continue-btn { background: #667eea; color: white; }
        .cancel-btn { background: #ddd; color: #333; }
        .error-msg, .success-msg, .info-msg { 
            margin-top: 10px; 
            display: none; 
            padding: 10px;
            border-radius: 5px;
        }
        .error-msg.active { 
            display: block; 
            background: #fee; 
            color: #e74c3c; 
            border: 1px solid #e74c3c;
        }
        .success-msg.active { 
            display: block; 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb;
        }
        .info-msg.active { 
            display: block; 
            background: #d1ecf1; 
            color: #0c5460; 
            border: 1px solid #bee5eb;
        }
        
        /* Payment Processing Overlay */
        .payment-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .payment-overlay.active { display: flex; }
        .payment-message {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            animation: pulse 2s infinite;
        }
        .payment-message h2 { color: #667eea; margin-bottom: 20px; }
        .payment-message p { color: #666; line-height: 1.8; }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        .resend-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        .resend-btn:hover { opacity: 0.9; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ Game Store</h1>
        <div id="loadingIndicator" class="loading">Loading products...</div>
        <div id="errorContainer"></div>
        <div id="productsContainer" class="products"></div>
    </div>
    
    <!-- Purchase Modal -->
    <div class="modal" id="purchaseModal">
        <div class="modal-content">
            <h2 id="modalTitle">Purchase Item</h2>
            <input type="email" id="emailInput" placeholder="Enter your email" />
            <div class="error-msg" id="errorMsg"></div>
            <div class="success-msg" id="successMsg"></div>
            <div class="info-msg" id="infoMsg"></div>
            <div id="resendBtnContainer"></div>
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="closeModal()">Cancel</button>
                <button class="continue-btn" id="buyNowBtn" onclick="processPurchase()">Buy Now</button>
            </div>
        </div>
    </div>
    
    <!-- Payment Processing Overlay -->
    <div class="payment-overlay" id="paymentOverlay">
        <div class="payment-message">
            <div class="spinner"></div>
            <h2>‚ö†Ô∏è Do Not Close This Page</h2>
            <p><strong>Your payment is being processed...</strong></p>
            <p>Please wait until you receive your redeem code.</p>
            <p style="font-size:14px;color:#999;margin-top:20px;">This window will close automatically after payment confirmation.</p>
        </div>
    </div>

<script>
// Load configuration
let CONFIG = null;
let SUPABASE_URL = '';
let SUPABASE_KEY = '';
let APPSCRIPT_URL = '';

let products = [];
let currentProduct = null;
let paymentWindow = null;

// Load config
async function loadConfig() {
    try {
        const response = await fetch('config.json');
        if (!response.ok) throw new Error('Config file not found');
        
        CONFIG = await response.json();
        SUPABASE_URL = CONFIG.supabase.url;
        SUPABASE_KEY = CONFIG.supabase.anon_key;
        APPSCRIPT_URL = CONFIG.appscript.url;
        
        console.log('‚úÖ Config loaded');
        return true;
    } catch (error) {
        console.error('‚ùå Failed to load config:', error);
        showError('Failed to load configuration. Please check config.json file.');
        return false;
    }
}

window.addEventListener('DOMContentLoaded', async () => {
    const configLoaded = await loadConfig();
    if (configLoaded) {
        loadProducts();
    }
});

async function loadProducts() {
    try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/products?select=*&enabled=eq.true`, {
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`
            }
        });
        
        if (!response.ok) throw new Error('Failed to load products');
        
        const data = await response.json();
        products = data.map(p => ({
            id: p.itemid,
            name: p.itemname,
            price: p.price,
            image: p.texture_preview || '',
            type: p.type,
            category: p.category
        }));
        
        displayProducts();
    } catch (error) {
        showError('Failed to load products. Please refresh.');
        console.error(error);
    }
}

function displayProducts() {
    const container = document.getElementById('productsContainer');
    const loading = document.getElementById('loadingIndicator');
    loading.style.display = 'none';
    
    if (products.length === 0) {
        showError('No products available.');
        return;
    }
    
    container.innerHTML = products.map(product => `
        <div class="product">
            <h2>${escapeHtml(product.name)}</h2>
            <div class="product-id">ID: ${escapeHtml(product.id)}</div>
            <img src="${escapeHtml(product.image)}" alt="${escapeHtml(product.name)}" 
                 class="product-image" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\"http://www.w3.org/2000/svg\" width=\"200\" height=\"200\"%3E%3Crect fill=\"%23ddd\" width=\"200\" height=\"200\"/%3E%3Ctext x=\"50%25\" y=\"50%25\" dominant-baseline=\"middle\" text-anchor=\"middle\" fill=\"%23999\"%3ENo Image%3C/text%3E%3C/svg%3E'">
            <div class="price">‚Çπ${escapeHtml(product.price)}/-</div>
            <button class="buy-btn" onclick="openPurchaseModal('${escapeHtml(product.id)}', '${escapeHtml(product.name)}', ${escapeHtml(product.price)})">
                Buy Now
            </button>
        </div>
    `).join('');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showError(message) {
    document.getElementById('errorContainer').innerHTML = `<div class="error">${message}</div>`;
    document.getElementById('loadingIndicator').style.display = 'none';
}

function openPurchaseModal(itemId, itemName, price) {
    currentProduct = { id: itemId, name: itemName, price: price };
    document.getElementById('modalTitle').textContent = `Purchase ${itemName}`;
    document.getElementById('purchaseModal').classList.add('active');
    document.getElementById('emailInput').value = '';
    document.getElementById('errorMsg').classList.remove('active');
    document.getElementById('successMsg').classList.remove('active');
    document.getElementById('infoMsg').classList.remove('active');
    document.getElementById('resendBtnContainer').innerHTML = '';
    document.getElementById('buyNowBtn').style.display = 'block';
}

function closeModal() {
    document.getElementById('purchaseModal').classList.remove('active');
}

async function processPurchase() {
    const email = document.getElementById('emailInput').value.trim();
    const errorMsg = document.getElementById('errorMsg');
    const successMsg = document.getElementById('successMsg');
    const infoMsg = document.getElementById('infoMsg');
    const buyBtn = document.getElementById('buyNowBtn');
    const resendContainer = document.getElementById('resendBtnContainer');
    
    // Clear all messages
    errorMsg.classList.remove('active');
    successMsg.classList.remove('active');
    infoMsg.classList.remove('active');
    resendContainer.innerHTML = '';
    
    if (!email || !email.includes('@')) {
        errorMsg.textContent = 'Please enter a valid email address';
        errorMsg.classList.add('active');
        return;
    }
    
    // Disable button
    buyBtn.disabled = true;
    buyBtn.textContent = 'Checking...';
    
    try {
        // STEP 1: Check if user already purchased this item
        buyBtn.textContent = 'Checking purchase history...';
        
        const checkPurchaseResponse = await fetch(`${SUPABASE_URL}/rest/v1/rpc/check_item_ownership`, {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                p_email: email, 
                p_item_id: currentProduct.id 
            })
        });
        
        const purchaseData = await checkPurchaseResponse.json();
        
        if (purchaseData.already_owned) {
            // User already owns this item
            if (purchaseData.is_redeemed) {
                // Case: Bought and redeemed
                infoMsg.innerHTML = '‚úÖ You already purchased and redeemed this item!<br><strong>Need help?</strong> Please contact support.';
                infoMsg.classList.add('active');
                buyBtn.style.display = 'none';
            } else {
                // Case: Bought but not redeemed - show resend option
                successMsg.innerHTML = '‚úÖ You already own this item!<br>Check your email for the redeem code.';
                successMsg.classList.add('active');
                resendContainer.innerHTML = '<button class="resend-btn" onclick="resendCode()">üìß Resend Code</button>';
                buyBtn.style.display = 'none';
            }
            buyBtn.disabled = false;
            buyBtn.textContent = 'Buy Now';
            return;
        }
        
        // STEP 2: Check if user is registered in profiles table
        buyBtn.textContent = 'Verifying registration...';
        
        const checkUserResponse = await fetch(`${SUPABASE_URL}/rest/v1/rpc/check_user_registered`, {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ p_email: email })
        });
        
        const userData = await checkUserResponse.json();
        
        if (!userData.registered) {
            // Case: User not registered
            errorMsg.textContent = '‚ùå Please register in the game first using this email address.';
            errorMsg.classList.add('active');
            buyBtn.disabled = false;
            buyBtn.textContent = 'Buy Now';
            return;
        }
        
        // STEP 3: Create payment link
        buyBtn.textContent = 'Creating payment link...';
        
        const paymentResponse = await fetch(APPSCRIPT_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'text/plain;charset=utf-8'  // FIXED: Use text/plain to avoid CORS
            },
            body: JSON.stringify({
                action: 'createPaymentLink',
                itemId: currentProduct.id,
                itemName: currentProduct.name,
                amount: currentProduct.price,
                email: email  // Email captured from modal
            })
        });
        
        const paymentData = await paymentResponse.json();
        
        if (!paymentData.success) {
            errorMsg.textContent = '‚ùå Failed to create payment link: ' + paymentData.message;
            errorMsg.classList.add('active');
            buyBtn.disabled = false;
            buyBtn.textContent = 'Buy Now';
            return;
        }
        
        // STEP 4: Open payment link and show warning overlay
        closeModal();
        
        paymentWindow = window.open(paymentData.paymentLinkUrl, '_blank', 'width=800,height=600');
        
        // Show overlay warning
        document.getElementById('paymentOverlay').classList.add('active');
        
        // Monitor payment window
        const checkWindowInterval = setInterval(() => {
            if (paymentWindow && paymentWindow.closed) {
                clearInterval(checkWindowInterval);
                document.getElementById('paymentOverlay').classList.remove('active');
            }
        }, 1000);
        
    } catch (error) {
        console.error('Purchase error:', error);
        errorMsg.textContent = '‚ùå An error occurred. Please try again.';
        errorMsg.classList.add('active');
    } finally {
        buyBtn.disabled = false;
        buyBtn.textContent = 'Buy Now';
    }
}

async function resendCode() {
    const email = document.getElementById('emailInput').value.trim();
    const successMsg = document.getElementById('successMsg');
    const errorMsg = document.getElementById('errorMsg');
    
    successMsg.classList.remove('active');
    errorMsg.classList.remove('active');
    
    try {
        const response = await fetch(APPSCRIPT_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'text/plain;charset=utf-8'
            },
            body: JSON.stringify({
                action: 'resendEmail',
                email: email,
                itemId: currentProduct.id
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            successMsg.textContent = '‚úÖ Code resent! Check your email.';
            successMsg.classList.add('active');
        } else {
            errorMsg.textContent = '‚ùå Failed to resend: ' + result.message;
            errorMsg.classList.add('active');
        }
    } catch (error) {
        console.error('Resend error:', error);
        errorMsg.textContent = '‚ùå Error resending code. Please try again.';
        errorMsg.classList.add('active');
    }
}

// Close modal on ESC key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeModal();
        document.getElementById('paymentOverlay').classList.remove('active');
    }
});

// Prevent accidental page close during payment
window.addEventListener('beforeunload', (e) => {
    const overlay = document.getElementById('paymentOverlay');
    if (overlay.classList.contains('active')) {
        e.preventDefault();
        e.returnValue = 'Payment in progress. Are you sure you want to leave?';
        return e.returnValue;
    }
});
</script>
</body>
</html>
