<!DOCTYPE html>
<html lang="en">
<head>
     <link rel="icon" type="image/png" sizes="32x32" href="images/logo.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Godot Visual Script Editor - AI-Powered Block Coding</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        :root {
            --primary: #ff6b35;
            --secondary: #2a2a2a;
            --accent: #00d9ff;
            --accent-light: #4de7ff;
            --light: #f8f9fa;
            --dark: #1a1a1a;
            --darker: #121212;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--darker) 0%, #2d1b69 100%);
            color: var(--light);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .main-header {
            padding: 100px 0 40px;
            text-align: center;
        }

        .main-header h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .main-header p {
            color: var(--accent-light);
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Editor Layout */
        .editor-layout {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 1.5rem;
            height: 700px;
            margin-bottom: 2rem;
        }

        /* Block Palette */
        .block-palette {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1.5rem;
            overflow-y: auto;
        }

        .palette-title {
            color: var(--primary);
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .block-category {
            margin-bottom: 2rem;
        }

        .category-title {
            color: var(--accent);
            margin-bottom: 0.8rem;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .block-type {
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            cursor: grab;
            font-size: 0.9rem;
            transition: all 0.2s;
            position: relative;
        }

        .block-type:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: var(--accent);
            transform: translateX(5px);
        }

        .block-type:active {
            cursor: grabbing;
        }

        .block-icon {
            font-size: 1.2rem;
            margin-right: 0.5rem;
        }

        /* Workspace */
        .workspace {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .workspace-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 1.5rem;
            overflow: auto;
        }

        .workspace-dropzone {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--accent-light);
            border: 2px dashed rgba(0, 217, 255, 0.3);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
        }

        .workspace-dropzone.hidden {
            display: none;
        }

        /* Extends Block (Fixed at Top) */
        .extends-container {
            background: rgba(255, 107, 53, 0.1);
            border: 2px solid var(--primary);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .extends-header {
            color: var(--primary);
            margin-bottom: 1rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .extends-select {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 1rem;
            font-family: inherit;
        }

        .extends-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.2);
        }

        /* Block Stack */
        .block-stack {
            min-height: 100px;
        }

        .block-instance {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1.2rem;
            margin-bottom: 1rem;
            position: relative;
            transition: all 0.3s;
        }

        .block-instance:hover {
            border-color: var(--accent);
            box-shadow: 0 4px 15px rgba(0, 217, 255, 0.1);
        }

        .block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .block-title {
            color: var(--accent);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .block-actions {
            display: flex;
            gap: 0.5rem;
        }

        .block-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .block-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent);
        }

        .block-config {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .config-group {
            margin-bottom: 1rem;
        }

        .config-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--accent-light);
            font-size: 0.85rem;
            font-weight: 500;
        }

        .config-input {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-family: inherit;
            font-size: 0.9rem;
        }

        .config-input:focus {
            outline: none;
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.08);
        }

        .config-select {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-family: inherit;
            font-size: 0.9rem;
        }

        /* Block Connections */
        .block-connector {
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            z-index: 5;
        }

        .connector-top {
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
        }

        .connector-bottom {
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
        }

        .connection-line {
            position: absolute;
            background: var(--accent);
            height: 2px;
            pointer-events: none;
            z-index: 1;
        }

        /* Panel Right - AI Generation */
        .generation-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1.5rem;
            overflow-y: auto;
        }

        .panel-title {
            color: var(--primary);
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
        }

        .ai-config {
            background: rgba(255, 107, 53, 0.1);
            padding: 1.2rem;
            border-radius: 10px;
            border: 1px solid rgba(255, 107, 53, 0.3);
            margin-bottom: 1.5rem;
        }

        .ai-config h4 {
            color: var(--accent);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .config-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .prompt-area {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .prompt-area h4 {
            color: var(--accent);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .generated-prompt {
            background: #1a1a2e;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Cascadia Code', 'Consolas', monospace;
            color: #e0e0ff;
            font-size: 0.9rem;
            line-height: 1.5;
            min-height: 200px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-bottom: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .code-output {
            background: #1a1a2e;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Cascadia Code', 'Consolas', monospace;
            color: #e0e0ff;
            font-size: 0.9rem;
            line-height: 1.5;
            min-height: 300px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
        }

        .code-output.active {
            display: block;
        }

        /* Controls */
        .editor-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary), #e55a2b);
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 107, 53, 0.4);
        }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--accent), #00b8d4);
        }

        .btn-secondary:hover {
            box-shadow: 0 8px 20px rgba(0, 217, 255, 0.4);
        }

        .btn-clear {
            background: linear-gradient(135deg, #6c757d, #495057);
        }

        .btn-clear:hover {
            box-shadow: 0 8px 20px rgba(108, 117, 125, 0.4);
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .spinner {
            border: 4px solid rgba(0, 217, 255, 0.1);
            border-top: 4px solid var(--accent);
            border-right: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Message */
        .message {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            animation: slideIn 0.3s ease;
        }

        .error-message {
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.2), rgba(220, 53, 69, 0.1));
            border: 1px solid #dc3545;
            color: #ff6b6b;
        }

        .success-message {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.2), rgba(40, 167, 69, 0.1));
            border: 1px solid #28a745;
            color: #6bff88;
        }

        @keyframes slideIn {
            from { transform: translateY(-10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .editor-layout {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .workspace {
                min-height: 500px;
            }
        }

        @media (max-width: 768px) {
            .main-header {
                padding: 80px 0 30px;
            }
            
            .main-header h1 {
                font-size: 2rem;
            }
            
            .editor-controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .block-config {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-header">
            <h1>üß± Godot Visual Block Editor</h1>
            <p>Drag blocks to design your script. AI generates production-ready Godot 4.4 GDScript.</p>
        </div>

        <!-- Editor Controls -->
        <div class="editor-controls">
            <button class="btn" id="generate-ai-code">
                <span>ü§ñ</span> Generate GDScript with AI
            </button>
            <button class="btn btn-secondary" id="generate-prompt">
                <span>üìù</span> Generate AI Prompt
            </button>
            <button class="btn btn-clear" id="clear-workspace">
                <span>üóëÔ∏è</span> Clear Workspace
            </button>
            <button class="btn btn-secondary" id="export-blocks">
                <span>üíæ</span> Export Blocks
            </button>
        </div>

        <!-- Main Editor Layout -->
        <div class="editor-layout">
            <!-- Left: Block Palette -->
            <div class="block-palette" id="block-palette">
                <h3 class="palette-title">üì¶ Block Library</h3>
                
                <div class="block-category">
                    <h4 class="category-title">üéÆ Input Blocks</h4>
                    <div class="block-type" data-type="input" draggable="true">
                        <span class="block-icon">üéÆ</span> Input Detection
                    </div>
                    <div class="block-type" data-type="keyboard" draggable="true">
                        <span class="block-icon">‚å®Ô∏è</span> Keyboard Input
                    </div>
                    <div class="block-type" data-type="mouse" draggable="true">
                        <span class="block-icon">üñ±Ô∏è</span> Mouse Input
                    </div>
                    <div class="block-type" data-type="touch" draggable="true">
                        <span class="block-icon">üëÜ</span> Touch Input
                    </div>
                </div>

                <div class="block-category">
                    <h4 class="category-title">üö∂ Movement Blocks</h4>
                    <div class="block-type" data-type="movement" draggable="true">
                        <span class="block-icon">üö∂</span> Basic Movement
                    </div>
                    <div class="block-type" data-type="jump" draggable="true">
                        <span class="block-icon">ü¶ò</span> Jump
                    </div>
                    <div class="block-type" data-type="gravity" draggable="true">
                        <span class="block-icon">‚¨áÔ∏è</span> Gravity
                    </div>
                    <div class="block-type" data-type="physics" draggable="true">
                        <span class="block-icon">‚öõÔ∏è</span> Physics Movement
                    </div>
                </div>

                <div class="block-category">
                    <h4 class="category-title">üé¨ Animation Blocks</h4>
                    <div class="block-type" data-type="animation" draggable="true">
                        <span class="block-icon">üé¨</span> Play Animation
                    </div>
                    <div class="block-type" data-type="animation-state" draggable="true">
                        <span class="block-icon">üîÑ</span> Animation State
                    </div>
                    <div class="block-type" data-type="blend" draggable="true">
                        <span class="block-icon">üé≠</span> Blend Animations
                    </div>
                </div>

                <div class="block-category">
                    <h4 class="category-title">üîä Audio Blocks</h4>
                    <div class="block-type" data-type="sound" draggable="true">
                        <span class="block-icon">üîä</span> Play Sound
                    </div>
                    <div class="block-type" data-type="music" draggable="true">
                        <span class="block-icon">üéµ</span> Play Music
                    </div>
                    <div class="block-type" data-type="volume" draggable="true">
                        <span class="block-icon">üîà</span> Volume Control
                    </div>
                </div>

                <div class="block-category">
                    <h4 class="category-title">‚öôÔ∏è Function Blocks</h4>
                    <div class="block-type" data-type="function" draggable="true">
                        <span class="block-icon">‚öôÔ∏è</span> Create Function
                    </div>
                    <div class="block-type" data-type="variable" draggable="true">
                        <span class="block-icon">üìä</span> Variable
                    </div>
                    <div class="block-type" data-type="return" draggable="true">
                        <span class="block-icon">‚Ü©Ô∏è</span> Return Value
                    </div>
                </div>

                <div class="block-category">
                    <h4 class="category-title">üì° Signal Blocks</h4>
                    <div class="block-type" data-type="signal" draggable="true">
                        <span class="block-icon">üì°</span> Define Signal
                    </div>
                    <div class="block-type" data-type="emit" draggable="true">
                        <span class="block-icon">üì§</span> Emit Signal
                    </div>
                    <div class="block-type" data-type="connect" draggable="true">
                        <span class="block-icon">üîó</span> Connect Signal
                    </div>
                </div>

                <div class="block-category">
                    <h4 class="category-title">‚ùì Logic Blocks</h4>
                    <div class="block-type" data-type="if" draggable="true">
                        <span class="block-icon">‚ùì</span> If Condition
                    </div>
                    <div class="block-type" data-type="for" draggable="true">
                        <span class="block-icon">üîÑ</span> For Loop
                    </div>
                    <div class="block-type" data-type="while" draggable="true">
                        <span class="block-icon">‚àû</span> While Loop
                    </div>
                    <div class="block-type" data-type="comparison" draggable="true">
                        <span class="block-icon">‚öñÔ∏è</span> Comparison
                    </div>
                </div>

                <div class="block-category">
                    <h4 class="category-title">üéØ Gameplay Blocks</h4>
                    <div class="block-type" data-type="health" draggable="true">
                        <span class="block-icon">‚ù§Ô∏è</span> Health System
                    </div>
                    <div class="block-type" data-type="damage" draggable="true">
                        <span class="block-icon">üí•</span> Damage System
                    </div>
                    <div class="block-type" data-type="collision" draggable="true">
                        <span class="block-icon">üí•</span> Collision Detection
                    </div>
                    <div class="block-type" data-type="area" draggable="true">
                        <span class="block-icon">üéØ</span> Area Detection
                    </div>
                </div>
            </div>

            <!-- Middle: Workspace -->
            <div class="workspace" id="workspace">
                <div class="workspace-container" id="workspace-container">
                    <!-- Fixed Extends Block -->
                    <div class="extends-container" id="extends-block">
                        <div class="extends-header">
                            <span>üìù</span> EXTENDS (Required)
                        </div>
                        <select class="extends-select" id="extends-select">
                            <option value="">Select Node Type...</option>
                            <option value="CharacterBody3D" selected>CharacterBody3D</option>
                            <option value="Node3D">Node3D</option>
                            <option value="Area3D">Area3D</option>
                            <option value="RigidBody3D">RigidBody3D</option>
                            <option value="Node2D">Node2D</option>
                            <option value="CharacterBody2D">CharacterBody2D</option>
                            <option value="Control">Control (UI)</option>
                            <option value="Node">Node</option>
                        </select>
                    </div>

                    <!-- Drop Zone -->
                    <div class="workspace-dropzone" id="workspace-dropzone">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üß±</div>
                        <h3>Drag blocks here to build your script</h3>
                        <p style="margin-top: 1rem; color: #aaa;">Start by dragging blocks from the left panel</p>
                    </div>

                    <!-- Block Stack (where blocks go) -->
                    <div class="block-stack" id="block-stack"></div>
                </div>
            </div>

            <!-- Right: AI Generation Panel -->
            <div class="generation-panel">
                <h3 class="panel-title">ü§ñ AI Generation</h3>
                
                <div class="ai-config">
                    <h4>AI Configuration</h4>
                    <div class="config-row">
                        <div class="config-group">
                            <label class="config-label">AI Provider</label>
                            <select class="config-select" id="ai-provider">
                                <option value="groq">Groq (Fast)</option>
                                <option value="gemini">Google Gemini</option>
                            </select>
                        </div>
                        <div class="config-group">
                            <label class="config-label">AI Model</label>
                            <select class="config-select" id="ai-model">
                                <option value="llama-3.3-70b-versatile">Llama 3.3 70B (Best)</option>
                                <option value="llama-3.1-8b-instant">Llama 3.1 8B (Fast)</option>
                                <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="prompt-area">
                    <h4>Generated AI Prompt</h4>
                    <div class="generated-prompt" id="generated-prompt">
                        <!-- AI prompt will appear here -->
                        Add blocks to generate AI prompt...
                    </div>
                    <button class="btn btn-secondary" id="copy-prompt" style="width: 100%;">
                        üìã Copy Prompt
                    </button>
                </div>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>AI is generating your GDScript...</p>
                </div>

                <div id="message-container"></div>

                <div class="code-output" id="code-output">
                    <!-- Generated code will appear here -->
                </div>

                <div style="margin-top: 1rem; display: none;" id="code-actions">
                    <button class="btn btn-secondary" id="copy-code" style="width: 100%; margin-bottom: 0.5rem;">
                        üìã Copy GDScript
                    </button>
                    <button class="btn" id="download-code" style="width: 100%;">
                        üíæ Download .gd File
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIGURATION ==========
        const API_KEYS = {
            groq: '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',
            gemini: 'AIzaSyCScOCC90fh1L2LybA3NYd63rAgb38M5j0'
        };

        const MODELS = {
            groq: [
                { value: 'llama-3.3-70b-versatile', label: 'Llama 3.3 70B (Best)' },
                { value: 'llama-3.1-8b-instant', label: 'Llama 3.1 8B (Fast)' },
                { value: 'mixtral-8x7b-32768', label: 'Mixtral 8x7B' }
            ],
            gemini: [
                { value: 'gemini-1.5-flash', label: 'Gemini 1.5 Flash' },
                { value: 'gemini-1.5-pro', label: 'Gemini 1.5 Pro' }
            ]
        };

        // ========== BLOCK DEFINITIONS ==========
        const BLOCK_CONFIGS = {
            // INPUT BLOCKS
            input: {
                name: "Input Detection",
                icon: "üéÆ",
                config: {
                    type: { label: "Input Type", type: "select", options: ["Action", "Key", "Mouse", "Touch"] },
                    name: { label: "Input Name", type: "text", placeholder: "move_right" },
                    event: { label: "Event Type", type: "select", options: ["pressed", "released", "just_pressed", "just_released"] }
                }
            },
            
            keyboard: {
    name: "Keyboard Input",
    icon: "‚å®Ô∏è",
    config: {
        key: { 
            label: "Key", 
            type: "select", 
            options: [
                // Alphabet
                "A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M",
                "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z",
                
                // Numbers
                "0", "1", "2", "3", "4", "5", "6", "7", "8", "9",
                
                // Function Keys
                "F1", "F2", "F3", "F4", "F5", "F6", "F7", "F8", "F9", "F10", "F11", "F12",
                
                // Modifier Keys
                "Shift", "Ctrl", "Alt", "Meta", "Super", "Hyper", "AltGr",
                
                // Navigation Keys
                "ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight",
                "Home", "End", "PageUp", "PageDown",
                
                // Special Keys
                "Space", "Enter", "Tab", "Backspace", "Delete", "Insert",
                "Escape", "CapsLock", "NumLock", "ScrollLock", "PrintScreen",
                "Pause", "Menu", "ContextMenu",
                
                // Numpad
                "NumPad0", "NumPad1", "NumPad2", "NumPad3", "NumPad4",
                "NumPad5", "NumPad6", "NumPad7", "NumPad8", "NumPad9",
                "NumPadMultiply", "NumPadAdd", "NumPadSubtract", 
                "NumPadDecimal", "NumPadDivide", "NumPadEnter",
                
                // Symbols
                "Backtick", "Minus", "Equal", "BracketLeft", "BracketRight",
                "Backslash", "Semicolon", "Apostrophe", "Comma", "Period", 
                "Slash", "IntlBackslash",
                
                // Media Keys
                "AudioVolumeUp", "AudioVolumeDown", "AudioVolumeMute",
                "MediaPlayPause", "MediaStop", "MediaNextTrack", "MediaPreviousTrack",
                
                // Special Characters
                "At", "Colon", "Caret", "Underscore", "Dollar", "Exclam", "Question",
                "Ampersand", "Asterisk", "ParenLeft", "ParenRight", "QuoteDbl",
                "Less", "Greater", "Bar", "Tilde", "Section", "Plus", "Percent",
                
                // System Keys
                "Sleep", "WakeUp", "Power", "Help", "Undo", "Redo", "Cut", "Copy", "Paste"
            ] 
        },
        event: { label: "Event Type", type: "select", options: ["pressed", "released", "just_pressed", "just_released"] }
    }
},
            
            // MOVEMENT BLOCKS
            movement: {
                name: "Basic Movement",
                icon: "üö∂",
                config: {
                    direction: { label: "Direction", type: "select", options: ["Forward", "Backward", "Left", "Right", "Up", "Down", "Custom"] },
                    speed: { label: "Speed", type: "number", placeholder: "5.0", min: "0", max: "100", step: "0.1" },
                    method: { label: "Movement Method", type: "select", options: ["velocity", "position", "translate"] }
                }
            },
            
            jump: {
                name: "Jump",
                icon: "ü¶ò",
                config: {
                    height: { label: "Jump Height", type: "number", placeholder: "4.0", min: "0", max: "20", step: "0.1" },
                    input: { label: "Input Method", type: "select", options: ["Space Key", "Action", "Touch"] },
                    gravity: { label: "Apply Gravity", type: "checkbox", default: true }
                }
            },
            
            // ANIMATION BLOCKS
            animation: {
                name: "Play Animation",
                icon: "üé¨",
                config: {
                    name: { label: "Animation Name", type: "text", placeholder: "run" },
                    player: { label: "Animation Player", type: "text", placeholder: "$AnimationPlayer" },
                    speed: { label: "Speed", type: "number", placeholder: "1.0", min: "0.1", max: "5", step: "0.1" },
                    direction: { label: "Direction", type: "select", options: ["Forward", "Reverse"] }
                }
            },
            
            // AUDIO BLOCKS
            sound: {
                name: "Play Sound",
                icon: "üîä",
                config: {
                    player: { label: "Audio Player", type: "text", placeholder: "$AudioStreamPlayer" },
                    file: { label: "Sound File", type: "text", placeholder: "res://sounds/jump.wav" },
                    volume: { label: "Volume", type: "range", min: "0", max: "100", step: "1", default: "100" }
                }
            },
            
            // FUNCTION BLOCKS
            function: {
                name: "Create Function",
                icon: "‚öôÔ∏è",
                config: {
                    name: { label: "Function Name", type: "text", placeholder: "_process" },
                    type: { label: "Function Type", type: "select", options: ["_ready", "_process", "_physics_process", "_input", "custom"] },
                    params: { label: "Parameters", type: "text", placeholder: "delta: float" }
                }
            },
            
            variable: {
                name: "Variable",
                icon: "üìä",
                config: {
                    name: { label: "Variable Name", type: "text", placeholder: "speed" },
                    type: { label: "Type", type: "select", options: ["float", "int", "String", "bool", "Vector3", "Array", "Dictionary"] },
                    value: { label: "Initial Value", type: "text", placeholder: "5.0" },
                    export: { label: "@export", type: "checkbox", default: false }
                }
            },
            
            // LOGIC BLOCKS
            if: {
                name: "If Condition",
                icon: "‚ùì",
                config: {
                    condition: { label: "Condition", type: "text", placeholder: "health > 0" },
                    operator: { label: "Operator", type: "select", options: ["==", "!=", ">", "<", ">=", "<=", "and", "or"] }
                }
            },
            
            // GAMEPLAY BLOCKS
            health: {
                name: "Health System",
                icon: "‚ù§Ô∏è",
                config: {
                    max: { label: "Max Health", type: "number", placeholder: "100", min: "1", max: "1000" },
                    current: { label: "Current Health", type: "number", placeholder: "100", min: "0", max: "1000" },
                    regen: { label: "Regeneration", type: "checkbox", default: false },
                    regen_rate: { label: "Regen Rate", type: "number", placeholder: "1", min: "0", max: "10" }
                }
            },
            
            damage: {
                name: "Damage System",
                icon: "üí•",
                config: {
                    amount: { label: "Damage Amount", type: "number", placeholder: "10", min: "1", max: "100" },
                    type: { label: "Damage Type", type: "select", options: ["melee", "ranged", "explosion", "environment"] },
                    source: { label: "Damage Source", type: "text", placeholder: "enemy" }
                }
            },
            
            // AREA DETECTION
            area: {
                name: "Area Detection",
                icon: "üéØ",
                config: {
                    type: { label: "Detection Type", type: "select", options: ["body_entered", "body_exited", "area_entered", "area_exited"] },
                    target: { label: "Target Type", type: "select", options: ["player", "enemy", "item", "bullet", "all"] },
                    response: { label: "Response", type: "text", placeholder: "take_damage(10)" }
                }
            }
        };

        // ========== STATE MANAGEMENT ==========
        let blocks = [];
        let currentBlockId = 0;
        let selectedExtends = "CharacterBody3D";

        // ========== DOM ELEMENTS ==========
        const workspace = document.getElementById('workspace');
        const workspaceContainer = document.getElementById('workspace-container');
        const workspaceDropzone = document.getElementById('workspace-dropzone');
        const blockStack = document.getElementById('block-stack');
        const extendsSelect = document.getElementById('extends-select');
        const generatedPrompt = document.getElementById('generated-prompt');
        const codeOutput = document.getElementById('code-output');
        const loading = document.getElementById('loading');
        const messageContainer = document.getElementById('message-container');
        const codeActions = document.getElementById('code-actions');

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', function() {
            initializeDragAndDrop();
            initializeEventListeners();
            updateModelOptions();
            
            // Set default extends value
            extendsSelect.addEventListener('change', function() {
                selectedExtends = this.value;
                updatePrompt();
            });
        });

        // ========== DRAG AND DROP ==========
        function initializeDragAndDrop() {
            // Make block types draggable
            document.querySelectorAll('.block-type').forEach(block => {
                block.addEventListener('dragstart', handleDragStart);
            });

            // Workspace drop handlers
            workspace.addEventListener('dragover', handleDragOver);
            workspace.addEventListener('dragleave', handleDragLeave);
            workspace.addEventListener('drop', handleDrop);
        }

        function handleDragStart(e) {
            const blockType = e.target.dataset.type;
            e.dataTransfer.setData('block-type', blockType);
            e.dataTransfer.effectAllowed = 'copy';
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
            workspace.style.borderColor = 'var(--accent)';
        }

        function handleDragLeave(e) {
            workspace.style.borderColor = 'rgba(255, 255, 255, 0.1)';
        }

        function handleDrop(e) {
            e.preventDefault();
            workspace.style.borderColor = 'rgba(255, 255, 255, 0.1)';
            
            const blockType = e.dataTransfer.getData('block-type');
            if (blockType) {
                addBlock(blockType);
            }
        }

        // ========== BLOCK MANAGEMENT ==========
        function addBlock(type) {
            const blockConfig = BLOCK_CONFIGS[type];
            if (!blockConfig) return;
            
            currentBlockId++;
            const blockId = `block-${currentBlockId}`;
            
            // Hide dropzone after first block
            if (blocks.length === 0) {
                workspaceDropzone.classList.add('hidden');
            }
            
            // Create block element
            const blockElement = document.createElement('div');
            blockElement.className = 'block-instance';
            blockElement.id = blockId;
            blockElement.dataset.type = type;
            
            // Block header
            const header = document.createElement('div');
            header.className = 'block-header';
            header.innerHTML = `
                <div class="block-title">
                    <span>${blockConfig.icon}</span>
                    <span>${blockConfig.name}</span>
                </div>
                <div class="block-actions">
                    <button class="block-btn" onclick="moveBlockUp('${blockId}')">‚Üë</button>
                    <button class="block-btn" onclick="moveBlockDown('${blockId}')">‚Üì</button>
                    <button class="block-btn" onclick="removeBlock('${blockId}')">√ó</button>
                </div>
            `;
            
            // Block configuration
            const configDiv = document.createElement('div');
            configDiv.className = 'block-config';
            
            if (blockConfig.config) {
                Object.entries(blockConfig.config).forEach(([key, config]) => {
                    const group = document.createElement('div');
                    group.className = 'config-group';
                    
                    const label = document.createElement('label');
                    label.className = 'config-label';
                    label.textContent = config.label;
                    
                    let input;
                    
                    switch(config.type) {
                        case 'select':
                            input = document.createElement('select');
                            input.className = 'config-select';
                            config.options.forEach(option => {
                                const opt = document.createElement('option');
                                opt.value = option;
                                opt.textContent = option;
                                input.appendChild(opt);
                            });
                            break;
                            
                        case 'number':
                        case 'text':
                            input = document.createElement('input');
                            input.type = config.type;
                            input.className = 'config-input';
                            input.placeholder = config.placeholder || '';
                            if (config.min) input.min = config.min;
                            if (config.max) input.max = config.max;
                            if (config.step) input.step = config.step;
                            if (config.default) input.value = config.default;
                            break;
                            
                        case 'range':
                            input = document.createElement('input');
                            input.type = 'range';
                            input.className = 'config-input';
                            input.min = config.min || '0';
                            input.max = config.max || '100';
                            input.step = config.step || '1';
                            if (config.default) input.value = config.default;
                            break;
                            
                        case 'checkbox':
                            input = document.createElement('input');
                            input.type = 'checkbox';
                            input.className = 'config-input';
                            if (config.default) input.checked = config.default;
                            break;
                    }
                    
                    input.dataset.configKey = key;
                    input.addEventListener('input', () => updateBlockConfig(blockId, key, input.value));
                    input.addEventListener('change', () => updateBlockConfig(blockId, key, input.type === 'checkbox' ? input.checked : input.value));
                    
                    group.appendChild(label);
                    group.appendChild(input);
                    configDiv.appendChild(group);
                });
            }
            
            blockElement.appendChild(header);
            blockElement.appendChild(configDiv);
            blockStack.appendChild(blockElement);
            
            // Add to blocks array
            blocks.push({
                id: blockId,
                type: type,
                config: {},
                order: blocks.length
            });
            
            updatePrompt();
        }

        function updateBlockConfig(blockId, key, value) {
            const block = blocks.find(b => b.id === blockId);
            if (block) {
                block.config[key] = value;
                updatePrompt();
            }
        }

        function removeBlock(blockId) {
            const blockIndex = blocks.findIndex(b => b.id === blockId);
            if (blockIndex > -1) {
                blocks.splice(blockIndex, 1);
                document.getElementById(blockId).remove();
                
                // Show dropzone if no blocks left
                if (blocks.length === 0) {
                    workspaceDropzone.classList.remove('hidden');
                }
                
                updatePrompt();
            }
        }

        function moveBlockUp(blockId) {
            const blockElement = document.getElementById(blockId);
            const prev = blockElement.previousElementSibling;
            
            if (prev && !prev.classList.contains('extends-container')) {
                blockStack.insertBefore(blockElement, prev);
                updateBlockOrder();
            }
        }

        function moveBlockDown(blockId) {
            const blockElement = document.getElementById(blockId);
            const next = blockElement.nextElementSibling;
            
            if (next) {
                blockStack.insertBefore(next, blockElement);
                updateBlockOrder();
            }
        }

        function updateBlockOrder() {
            const blockElements = Array.from(blockStack.querySelectorAll('.block-instance'));
            blockElements.forEach((element, index) => {
                const block = blocks.find(b => b.id === element.id);
                if (block) {
                    block.order = index;
                }
            });
            blocks.sort((a, b) => a.order - b.order);
            updatePrompt();
        }

        // ========== PROMPT GENERATION ==========
        function updatePrompt() {
            if (blocks.length === 0) {
                generatedPrompt.textContent = "Add blocks to generate AI prompt...";
                return;
            }
            
            let prompt = `Create Godot 4.4 GDScript for a ${selectedExtends} node with the following specifications:\n\n`;
            
            prompt += `EXTENDS: ${selectedExtends}\n\n`;
            
            prompt += "BLOCK SPECIFICATIONS:\n";
            
            blocks.forEach((block, index) => {
                const config = BLOCK_CONFIGS[block.type];
                prompt += `${index + 1}. ${config.name}:\n`;
                
                if (Object.keys(block.config).length > 0) {
                    Object.entries(block.config).forEach(([key, value]) => {
                        const configDef = config.config[key];
                        if (configDef && value !== undefined && value !== '') {
                            prompt += `   - ${configDef.label}: ${value}\n`;
                        }
                    });
                } else {
                    prompt += `   - (Default settings)\n`;
                }
            });
            
            prompt += `\nGENERATION RULES:\n`;
            prompt += `1. Use Godot 4.4 syntax and best practices\n`;
            prompt += `2. Include proper type hints\n`;
            prompt += `3. Add comments explaining logic\n`;
            prompt += `4. Make code modular and reusable\n`;
            prompt += `5. Include error handling where appropriate\n`;
            prompt += `6. Optimize for performance\n`;
            
            generatedPrompt.textContent = prompt;
        }

        // ========== AI GENERATION ==========
        async function generateGDScript() {
            if (blocks.length === 0) {
                showMessage('error', 'Add at least one block to generate code.');
                return;
            }
            
            const provider = document.getElementById('ai-provider').value;
            const model = document.getElementById('ai-model').value;
            const prompt = generatedPrompt.textContent;
            
            // Show loading
            loading.classList.add('active');
            codeOutput.classList.remove('active');
            codeActions.style.display = 'none';
            
            try {
                const code = await callAI(prompt, provider, model);
                displayCode(code);
                showMessage('success', '‚úÖ GDScript generated successfully!');
            } catch (error) {
                showMessage('error', `‚ùå Error: ${error.message}`);
            } finally {
                loading.classList.remove('active');
            }
        }

        async function callAI(prompt, provider, model) {
            const systemPrompt = `You are an expert Godot 4.4 game developer. Generate clean, production-ready GDScript 4.4 code following these STRICT rules:

IMPORTANT RULES:
1. Use ONLY Godot 4.4 OFFICIAL syntax from the official documentation
2. ALWAYS use 3D nodes and systems unless SPECIFICALLY asked for 2D
3. Use proper type hints for ALL variables and functions
4. Include comprehensive comments explaining logic
5. Follow Godot best practices and naming conventions
6. Use @export for important properties
7. Include proper error handling
8. Make the code modular and reusable
9. DO NOT include markdown code blocks or explanations
10. Return ONLY the GDScript code

DEFAULT TO 3D:
- Use CharacterBody3D for player characters
- Use Node3D for 3D nodes
- Use Vector3 for 3D vectors
- Use 3D physics and collisions

ONLY use 2D if user explicitly asks for "2D" in their request.

User request: ${prompt}

Generate ONLY the GDScript code.`;

            if (provider === 'groq') {
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEYS.groq}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: prompt }
                        ],
                        temperature: 0.7,
                        max_tokens: 4000
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'API Error');
                }

                const data = await response.json();
                return data.choices[0].message.content.trim();
            } else { // gemini
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${API_KEYS.gemini}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: systemPrompt }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 4000
                        }
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'API Error');
                }

                const data = await response.json();
                return data.candidates[0].content.parts[0].text.trim();
            }
        }

        function displayCode(code) {
            code = code.replace(/```(?:gdscript|tscn)?\n?/g, '').replace(/```/g, '').trim();
            codeOutput.textContent = code;
            codeOutput.classList.add('active');
            codeActions.style.display = 'block';
            
            // Scroll to code output
            codeOutput.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // ========== UTILITY FUNCTIONS ==========
        function showMessage(type, text) {
            // Remove existing messages
            messageContainer.innerHTML = '';
            
            const message = document.createElement('div');
            message.className = `message ${type}-message`;
            message.textContent = text;
            
            messageContainer.appendChild(message);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (message.parentNode) {
                    message.remove();
                }
            }, 5000);
        }

        function updateModelOptions() {
            const provider = document.getElementById('ai-provider');
            const model = document.getElementById('ai-model');
            
            provider.addEventListener('change', function() {
                model.innerHTML = '';
                const models = MODELS[this.value];
                
                models.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m.value;
                    option.textContent = m.label;
                    model.appendChild(option);
                });
            });
        }

        function clearWorkspace() {
            if (confirm('Are you sure you want to clear all blocks?')) {
                blocks = [];
                blockStack.innerHTML = '';
                workspaceDropzone.classList.remove('hidden');
                updatePrompt();
                codeOutput.classList.remove('active');
                codeActions.style.display = 'none';
                showMessage('success', 'Workspace cleared.');
            }
        }

        function exportBlocks() {
            const exportData = {
                extends: selectedExtends,
                blocks: blocks,
                timestamp: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `godot-blocks-${Date.now()}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showMessage('success', 'Blocks exported successfully!');
        }

        // ========== EVENT LISTENERS ==========
        function initializeEventListeners() {
            // Generate AI Code
            document.getElementById('generate-ai-code').addEventListener('click', generateGDScript);
            
            // Generate Prompt Only
            document.getElementById('generate-prompt').addEventListener('click', updatePrompt);
            
            // Clear Workspace
            document.getElementById('clear-workspace').addEventListener('click', clearWorkspace);
            
            // Export Blocks
            document.getElementById('export-blocks').addEventListener('click', exportBlocks);
            
            // Copy Prompt
            document.getElementById('copy-prompt').addEventListener('click', function() {
                navigator.clipboard.writeText(generatedPrompt.textContent).then(() => {
                    showMessage('success', '‚úÖ Prompt copied to clipboard!');
                });
            });
            
            // Copy Code
            document.getElementById('copy-code').addEventListener('click', function() {
                navigator.clipboard.writeText(codeOutput.textContent).then(() => {
                    showMessage('success', '‚úÖ GDScript copied to clipboard!');
                });
            });
            
            // Download Code
            document.getElementById('download-code').addEventListener('click', function() {
                const code = codeOutput.textContent;
                const filename = `godot-script-${Date.now()}.gd`;
                const blob = new Blob([code], { type: 'text/x-gdscript' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showMessage('success', '‚úÖ GDScript downloaded!');
            });
        }

        // ========== GLOBAL FUNCTIONS ==========
        window.moveBlockUp = moveBlockUp;
        window.moveBlockDown = moveBlockDown;
        window.removeBlock = removeBlock;
        window.updateBlockConfig = updateBlockConfig;
    </script>
</body>
</html>
